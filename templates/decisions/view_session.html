{% extends "decisions/base.html" %}

{% block title %}{{ session.name }} - Decisioni{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('decisions.index') }}">Lista Sessioni</a></li>
<li class="breadcrumb-item active">{{ session.name }}</li>
{% endblock %}

{% block page_title %}{{ session.name }}{% endblock %}
{% block page_description %}{{ session.description or "Sessione di decisione collaborativa" }}{% endblock %}

{% block page_actions %}
<div class="dropdown">
    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-gear"></i> Azioni
    </button>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('decisions.list_proposals', session_id=session.id) }}">
            <i class="bi bi-list-ul"></i> Visualizza Proposte
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('decisions.create_proposal', session_id=session.id) }}">
            <i class="bi bi-plus-lg"></i> Nuova Proposta
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('decisions.import_csv', session_id=session.id) }}">
            <i class="bi bi-upload"></i> Importa CSV
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('decisions.export_decisions', session_id=session.id) }}">
            <i class="bi bi-download"></i> Esporta Risultati
        </a></li>
        {% if session.can_edit(current_user) %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('decisions.edit_session', session_id=session.id) }}">
                <i class="bi bi-pencil"></i> Modifica Sessione
            </a></li>
        {% endif %}
    </ul>
</div>
{% endblock %}

{% block decision_content %}
<!-- Session Status and Info -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <span class="status-badge status-{{ session.status }}">{{ session.status.title() }}</span>
                        <div class="mt-2 text-muted small">
                            <i class="bi bi-person"></i> Creata da {{ session.creator.username }} 
                            il {{ session.created_at.strftime('%d/%m/%Y alle %H:%M') }}
                        </div>
                    </div>
                    <div class="text-center">
                        <svg class="progress-ring" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="54" stroke="#e9ecef" />
                            <circle cx="60" cy="60" r="54" stroke="#28a745" 
                                    style="stroke-dasharray: 339.292; stroke-dashoffset: {{ 339.292 - (session.completion_percentage / 100 * 339.292) }};" />
                        </svg>
                        <div class="mt-2 text-center">
                            <div class="h5 mb-0">{{ '%.1f'|format(session.completion_percentage) }}%</div>
                            <small class="text-muted">Completamento</small>
                        </div>
                    </div>
                </div>
                
                <div class="row text-center">
                    <div class="col-3">
                        <div class="h4 mb-0" id="proposal-count">{{ session.proposal_count }}</div>
                        <small class="text-muted">Proposte Totali</small>
                    </div>
                    <div class="col-3">
                        <div class="h4 mb-0 text-success" id="approved-count">{{ session.approved_proposals_count }}</div>
                        <small class="text-muted">Approvate</small>
                    </div>
                    <div class="col-3">
                        <div class="h4 mb-0 text-warning" id="pending-count">{{ session.pending_proposals_count }}</div>
                        <small class="text-muted">In Attesa</small>
                    </div>
                    <div class="col-3">
                        <div class="h4 mb-0" id="participants-count">{{ participants|length }}</div>
                        <small class="text-muted">Partecipanti</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Configurazione</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Soglia Approvazione:</strong> {{ (session.voting_threshold * 100)|int }}%
                </div>
                <div class="mb-2">
                    <strong>Commenti Pubblici:</strong> 
                    {% if session.allow_public_comments %}
                        <span class="text-success">Attivi</span>
                    {% else %}
                        <span class="text-muted">Disattivati</span>
                    {% endif %}
                </div>
                <div>
                    <strong>Ultimo Aggiornamento:</strong><br>
                    <small class="text-muted">{{ session.updated_at.strftime('%d/%m/%Y alle %H:%M') }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs nav-decisions mb-4" role="tablist">
    <li class="nav-item">
        <a class="nav-link {{ 'active' if active_tab == 'overview' }}" 
           href="{{ url_for('decisions.view_session', session_id=session.id, tab='overview') }}">
            <i class="bi bi-house"></i> Panoramica
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {{ 'active' if active_tab == 'proposals' }}" 
           href="{{ url_for('decisions.list_proposals', session_id=session.id) }}">
            <i class="bi bi-list-ul"></i> Proposte ({{ session.proposal_count }})
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {{ 'active' if active_tab == 'participants' }}" 
           href="{{ url_for('decisions.view_session', session_id=session.id, tab='participants') }}">
            <i class="bi bi-people"></i> Partecipanti ({{ participants|length }})
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {{ 'active' if active_tab == 'comments' }}" 
           href="{{ url_for('decisions.view_session', session_id=session.id, tab='comments') }}">
            <i class="bi bi-chat-dots"></i> Discussioni
        </a>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
    <!-- Overview Tab -->
    {% if active_tab == 'overview' %}
        <div class="row">
            <!-- Recent Proposals -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Proposte Recenti</h6>
                        <a href="{{ url_for('decisions.list_proposals', session_id=session.id) }}" class="btn btn-sm btn-outline-primary">
                            Vedi Tutte
                        </a>
                    </div>
                    <div class="card-body">
                        {% if recent_proposals %}
                            {% for proposal in recent_proposals %}
                                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">
                                            <a href="{{ url_for('decisions.view_proposal', session_id=session.id, proposal_id=proposal.id) }}" 
                                               class="text-decoration-none">
                                                {{ proposal.proposed_code }} — {{ proposal.proposed_label }}
                                            </a>
                                        </div>
                                        <div class="text-muted small">{{ proposal.category }}</div>
                                        <div class="text-muted small">
                                            <i class="bi bi-person"></i> {{ proposal.creator.username }} • 
                                            <i class="bi bi-calendar"></i> {{ proposal.created_at.strftime('%d/%m') }}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="status-badge status-{{ proposal.status }}">{{ proposal.status.title() }}</span>
                                        <div class="small text-muted">{{ proposal.total_votes }} voti</div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-6"></i>
                                <p class="mt-2 mb-0">Nessuna proposta ancora</p>
                                <a href="{{ url_for('decisions.create_proposal', session_id=session.id) }}" class="btn btn-sm btn-primary mt-2">
                                    Crea Prima Proposta
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Recent Comments -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Discussioni Recenti</h6>
                    </div>
                    <div class="card-body">
                        {% if recent_comments %}
                            {% for comment in recent_comments %}
                                <div class="d-flex mb-3 pb-3 border-bottom">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            {{ comment.user.username[0]|upper }}
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">{{ comment.user.username }}</div>
                                        <div class="text-muted small mb-1">{{ comment.created_at.strftime('%d/%m/%Y alle %H:%M') }}</div>
                                        <div class="small">{{ comment.content_preview }}</div>
                                        {% if comment.proposal %}
                                            <div class="text-primary small">
                                                <i class="bi bi-arrow-right"></i> 
                                                <a href="{{ url_for('decisions.view_proposal', session_id=session.id, proposal_id=comment.proposal.id) }}">
                                                    {{ comment.proposal.proposed_code }}
                                                </a>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-chat display-6"></i>
                                <p class="mt-2 mb-0">Nessuna discussione ancora</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Azioni Rapide</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <a href="{{ url_for('decisions.create_proposal', session_id=session.id) }}" 
                                   class="btn btn-outline-primary w-100">
                                    <i class="bi bi-plus-lg"></i><br>Nuova Proposta
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="{{ url_for('decisions.import_csv', session_id=session.id) }}" 
                                   class="btn btn-outline-success w-100">
                                    <i class="bi bi-upload"></i><br>Importa CSV
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="{{ url_for('decisions.list_proposals', session_id=session.id) }}" 
                                   class="btn btn-outline-info w-100">
                                    <i class="bi bi-list-ul"></i><br>Vedi Proposte
                                </a>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="{{ url_for('decisions.export_decisions', session_id=session.id) }}" 
                                   class="btn btn-outline-warning w-100">
                                    <i class="bi bi-download"></i><br>Esporta Risultati
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    <!-- Participants Tab -->
    {% if active_tab == 'participants' %}
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Lista Partecipanti</h6>
                    </div>
                    <div class="card-body">
                        {% if participants %}
                            <div class="row">
                                {% for participant in participants %}
                                    <div class="col-md-6 mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                 style="width: 50px; height: 50px;">
                                                {{ participant.username[0]|upper }}
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ participant.username }}</div>
                                                <div class="text-muted small">{{ participant.role.title() }}</div>
                                                {% if participant.last_login %}
                                                    <div class="text-muted small">
                                                        Ultimo accesso: {{ participant.last_login.strftime('%d/%m/%Y') }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-people display-6"></i>
                                <p class="mt-2 mb-0">Nessun partecipante ancora</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Statistiche Partecipazione</h6>
                    </div>
                    <div class="card-body">
                        <!-- Add participation stats here -->
                        <div class="text-center text-muted">
                            <i class="bi bi-graph-up"></i>
                            <p class="mt-2 mb-0">Statistiche in arrivo</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    <!-- Comments Tab -->
    {% if active_tab == 'comments' %}
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Discussioni Generali</h6>
                    </div>
                    <div class="card-body">
                        <!-- Add comment form -->
                        {% if session.allow_public_comments %}
                            <form method="POST" action="{{ url_for('decisions.add_session_comment', session_id=session.id) }}" class="mb-4">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="mb-3">
                                    <label for="content" class="form-label">Aggiungi un commento</label>
                                    <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-chat-left-text"></i> Pubblica Commento
                                </button>
                            </form>
                        {% endif %}
                        
                        <!-- Comments list -->
                        <div class="comments-section">
                            <!-- Add comments display here -->
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-chat-dots display-6"></i>
                                <p class="mt-2 mb-0">Inizia una discussione!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Linee Guida</h6>
                    </div>
                    <div class="card-body">
                        <ul class="small mb-0">
                            <li>Mantieni i commenti costruttivi e rispettosi</li>
                            <li>Usa discussioni specifiche per le singole proposte</li>
                            <li>Questa sezione è per discussioni generali sulla sessione</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block decision_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Start auto-updating stats
    startStatsUpdate({{ session.id }});
    
    // Initialize progress ring
    const progressRing = document.querySelector('.progress-ring');
    if (progressRing) {
        DecisionUtils.updateProgressRing(progressRing, {{ session.completion_percentage }});
    }
});
</script>
{% endblock %}
