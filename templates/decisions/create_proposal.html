{% extends "decisions/base.html" %}

{% block title %}Crea Nuova Proposta - {{ session.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('decisions.index') }}">Lista Sessioni</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('decisions.view_session', session_id=session.id) }}">{{ session.name }}</a></li>
<li class="breadcrumb-item active">Nuova Proposta</li>
{% endblock %}

{% block page_title %}Crea Nuova Proposta{% endblock %}
{% block page_description %}{{ session.name }} - Aggiungi una nuova proposta di raggruppamento etichette{% endblock %}

{% block decision_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Session Info -->
        <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
            <div>
                <i class="bi bi-info-circle"></i>
                <strong>Sessione:</strong> {{ session.name }}
                <span class="ms-3">
                    <strong>Soglia Approvazione:</strong> {{ (session.voting_threshold * 100)|int }}%
                </span>
            </div>
            <span class="status-badge status-{{ session.status }}">{{ session.status.title() }}</span>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle text-primary"></i> 
                    Nuova Proposta di Raggruppamento
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="createProposalForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <!-- Codice e Etichetta Proposta -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="proposed_code" class="form-label required">Codice Proposto</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="proposed_code" 
                                   name="proposed_code" 
                                   required 
                                   placeholder="es: AI_TOOLS"
                                   maxlength="50">
                            <div class="form-text">
                                Codice univoco per identificare il gruppo
                            </div>
                        </div>
                        <div class="col-md-8">
                            <label for="proposed_label" class="form-label required">Etichetta Proposta</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="proposed_label" 
                                   name="proposed_label" 
                                   required 
                                   placeholder="es: Strumenti di Intelligenza Artificiale"
                                   maxlength="200">
                            <div class="form-text">
                                Nome descrittivo del gruppo di etichette
                            </div>
                        </div>
                    </div>
                    
                    <!-- Categoria -->
                    <div class="mb-4">
                        <label for="category" class="form-label required">Categoria</label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="">Seleziona una categoria...</option>
                            {% for cat in categories %}
                                <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Categoria tematica del raggruppamento
                        </div>
                    </div>
                    
                    <!-- Etichette Originali -->
                    <div class="mb-4">
                        <label for="original_labels" class="form-label required">Etichette Originali da Raggruppare</label>
                        <textarea class="form-control" 
                                  id="original_labels" 
                                  name="original_labels" 
                                  rows="4" 
                                  required 
                                  placeholder="Inserisci le etichette originali separate da virgole o una per riga..."></textarea>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            Inserisci le etichette che vuoi raggruppare, separate da virgole o una per riga
                        </div>
                        <div id="label-preview" class="mt-2"></div>
                    </div>
                    
                    <!-- Motivazione -->
                    <div class="mb-4">
                        <label for="rationale" class="form-label">Motivazione</label>
                        <textarea class="form-control" 
                                  id="rationale" 
                                  name="rationale" 
                                  rows="4" 
                                  placeholder="Spiega perché queste etichette dovrebbero essere raggruppate insieme..."></textarea>
                        <div class="form-text">
                            Descrivi la logica del raggruppamento per aiutare gli altri a comprendere la proposta
                        </div>
                    </div>
                    
                    <!-- Anteprima Proposta -->
                    <div class="card border-info mb-4" id="proposal-preview" style="display: none;">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-eye"></i> Anteprima Proposta
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Codice:</strong>
                                    <div id="preview-code" class="badge bg-primary fs-6"></div>
                                </div>
                                <div class="col-md-9">
                                    <strong>Etichetta:</strong>
                                    <div id="preview-label" class="h6"></div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <strong>Categoria:</strong>
                                <span id="preview-category" class="text-muted"></span>
                            </div>
                            <div class="mt-2">
                                <strong>Etichette Raggruppate:</strong>
                                <div id="preview-labels" class="mt-1"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="d-flex gap-3 pt-3 border-top">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-check-lg"></i> Crea Proposta
                        </button>
                        <a href="{{ url_for('decisions.view_session', session_id=session.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg"></i> Annulla
                        </a>
                        <button type="button" class="btn btn-outline-info" id="previewBtn">
                            <i class="bi bi-eye"></i> Anteprima
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Tips -->
        <div class="card mt-4 border-success">
            <div class="card-header bg-light">
                <h6 class="mb-0 text-success">
                    <i class="bi bi-lightbulb"></i> Suggerimenti
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li><strong>Usa nomi descrittivi:</strong> Il codice dovrebbe essere breve ma identificativo</li>
                    <li><strong>Raggruppa logicamente:</strong> Le etichette dovrebbero avere concetti simili o correlati</li>
                    <li><strong>Spiega la motivazione:</strong> Una buona spiegazione aiuta gli altri a comprendere e approvare</li>
                    <li><strong>Controlla duplicati:</strong> Verifica che non esista già una proposta simile</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block decision_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createProposalForm');
    const submitBtn = document.getElementById('submitBtn');
    const previewBtn = document.getElementById('previewBtn');
    const previewCard = document.getElementById('proposal-preview');
    
    // Real-time validation and preview
    const fields = {
        code: document.getElementById('proposed_code'),
        label: document.getElementById('proposed_label'),
        category: document.getElementById('category'),
        labels: document.getElementById('original_labels')
    };
    
    // Update preview when fields change
    Object.values(fields).forEach(field => {
        field.addEventListener('input', updatePreview);
        field.addEventListener('change', updatePreview);
    });
    
    // Preview button
    previewBtn.addEventListener('click', function() {
        updatePreview();
        if (previewCard.style.display === 'none') {
            previewCard.style.display = 'block';
            this.innerHTML = '<i class="bi bi-eye-slash"></i> Nascondi Anteprima';
        } else {
            previewCard.style.display = 'none';
            this.innerHTML = '<i class="bi bi-eye"></i> Anteprima';
        }
    });
    
    function updatePreview() {
        const code = fields.code.value.trim();
        const label = fields.label.value.trim();
        const category = fields.category.value;
        const labelsText = fields.labels.value.trim();
        
        // Update preview elements
        document.getElementById('preview-code').textContent = code || 'CODICE';
        document.getElementById('preview-label').textContent = label || 'Nome Etichetta';
        document.getElementById('preview-category').textContent = category || 'Nessuna categoria';
        
        // Parse and display labels
        const labelsList = parseLabels(labelsText);
        const labelsContainer = document.getElementById('preview-labels');
        labelsContainer.innerHTML = '';
        
        if (labelsList.length > 0) {
            labelsList.forEach(lbl => {
                const span = document.createElement('span');
                span.className = 'label-tag me-1 mb-1';
                span.textContent = lbl;
                labelsContainer.appendChild(span);
            });
        } else {
            labelsContainer.innerHTML = '<span class="text-muted">Nessuna etichetta inserita</span>';
        }
        
        // Update label preview in form
        updateLabelPreview(labelsList);
    }
    
    function updateLabelPreview(labels) {
        const preview = document.getElementById('label-preview');
        if (labels.length > 0) {
            preview.innerHTML = `
                <div class="small text-success">
                    <i class="bi bi-check-circle"></i> 
                    ${labels.length} etichette riconosciute:
                </div>
                <div class="mt-1">
                    ${labels.map(lbl => `<span class="label-tag me-1">${lbl}</span>`).join('')}
                </div>
            `;
        } else {
            preview.innerHTML = '';
        }
    }
    
    function parseLabels(text) {
        if (!text) return [];
        
        // Split by commas or newlines
        const labels = text.split(/[,\n]/)
            .map(label => label.trim())
            .filter(label => label.length > 0);
        
        return [...new Set(labels)]; // Remove duplicates
    }
    
    // Form submission
    form.addEventListener('submit', function(e) {
        const originalContent = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creazione...';
        submitBtn.disabled = true;
        
        // Basic validation
        const code = fields.code.value.trim();
        const label = fields.label.value.trim();
        const category = fields.category.value;
        const labelsText = fields.labels.value.trim();
        
        let hasError = false;
        
        if (!code) {
            showFieldError(fields.code, 'Il codice è obbligatorio');
            hasError = true;
        }
        
        if (!label) {
            showFieldError(fields.label, 'L\'etichetta è obbligatoria');
            hasError = true;
        }
        
        if (!category) {
            showFieldError(fields.category, 'La categoria è obbligatoria');
            hasError = true;
        }
        
        const labelsList = parseLabels(labelsText);
        if (labelsList.length === 0) {
            showFieldError(fields.labels, 'Inserisci almeno una etichetta da raggruppare');
            hasError = true;
        }
        
        if (hasError) {
            e.preventDefault();
            DecisionUtils.hideLoading(submitBtn, originalContent);
            DecisionUtils.showToast('Completa tutti i campi obbligatori', 'danger');
        }
    });
    
    function showFieldError(field, message) {
        field.classList.add('is-invalid');
        
        // Remove existing error message
        const existingError = field.parentNode.querySelector('.invalid-feedback');
        if (existingError) {
            existingError.remove();
        }
        
        // Add new error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
        
        // Remove error on next input
        field.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            const errorEl = this.parentNode.querySelector('.invalid-feedback');
            if (errorEl) errorEl.remove();
        }, { once: true });
    }
    
    // Auto-generate code from label
    fields.label.addEventListener('input', function() {
        const code = fields.code;
        if (!code.value.trim()) {
            const autoCode = this.value
                .trim()
                .toUpperCase()
                .replace(/[^A-Z0-9\s]/g, '')
                .replace(/\s+/g, '_')
                .substring(0, 20);
            code.value = autoCode;
            updatePreview();
        }
    });
});
</script>
{% endblock %}
