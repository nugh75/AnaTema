{% extends "decisions/base.html" %}

{% block title %}Importa Proposte da CSV - {{ session.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('decisions.index') }}">Lista Sessioni</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('decisions.view_session', session_id=session.id) }}">{{ session.name }}</a></li>
<li class="breadcrumb-item active">Importa CSV</li>
{% endblock %}

{% block page_title %}Importa Proposte da CSV{% endblock %}
{% block page_description %}{{ session.name }} - Carica proposte di raggruppamento dal file CSV esistente{% endblock %}

{% block decision_content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Session Info -->
        <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
            <div>
                <i class="bi bi-info-circle"></i>
                <strong>Sessione:</strong> {{ session.name }}
                <span class="ms-3">
                    <strong>Soglia Approvazione:</strong> {{ (session.voting_threshold * 100)|int }}%
                </span>
            </div>
            <span class="status-badge status-{{ session.status }}">{{ session.status.title() }}</span>
        </div>

        <!-- Import Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-upload text-success"></i> 
                    Importa Proposte da File CSV
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="importForm">
                    {{ csrf_token() }}
                    
                    <!-- File Upload -->
                    <div class="mb-4">
                        <label for="csv_file" class="form-label required">File CSV</label>
                        <input type="file" 
                               class="form-control" 
                               id="csv_file" 
                               name="csv_file" 
                               accept=".csv"
                               required>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            Seleziona il file CSV contenente i raggruppamenti delle etichette
                        </div>
                    </div>
                    
                    <!-- CSV Format Info -->
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="bi bi-exclamation-triangle"></i> Formato CSV Richiesto
                        </h6>
                        <p class="mb-2">Il file CSV deve contenere le seguenti colonne:</p>
                        <ul class="mb-2">
                            <li><strong>proposed_code</strong> - Codice del raggruppamento (es: AI_TOOLS)</li>
                            <li><strong>proposed_label</strong> - Nome del raggruppamento (es: Strumenti AI)</li>
                            <li><strong>category</strong> - Categoria tematica</li>
                            <li><strong>original_labels</strong> - Etichette originali separate da virgole</li>
                            <li><strong>rationale</strong> - Motivazione del raggruppamento (opzionale)</li>
                        </ul>
                        <p class="mb-0">
                            <strong>Suggerimento:</strong> Puoi usare il file <code>tutte_etichette_raggruppate.csv</code> esistente
                        </p>
                    </div>
                    
                    <!-- Import Options -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Opzioni di Importazione</label>
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="skip_duplicates" 
                                       name="skip_duplicates" 
                                       checked>
                                <label class="form-check-label" for="skip_duplicates">
                                    Salta proposte duplicate
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="auto_assign_creator" 
                                       name="auto_assign_creator" 
                                       checked>
                                <label class="form-check-label" for="auto_assign_creator">
                                    Assegna come creatore l'utente corrente
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="default_category" class="form-label">Categoria Predefinita (se mancante)</label>
                            <select class="form-select" id="default_category" name="default_category">
                                <option value="">Usa quella specificata nel CSV</option>
                                <option value="Generale">Generale</option>
                                <option value="Tecnico">Tecnico</option>
                                <option value="Contenuto">Contenuto</option>
                                <option value="Altro">Altro</option>
                            </select>
                            <div class="form-text">
                                Categoria da usare se non specificata nel CSV
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview Section -->
                    <div id="preview-section" class="mb-4" style="display: none;">
                        <h6><i class="bi bi-eye"></i> Anteprima Dati CSV</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped" id="preview-table">
                                <thead class="table-dark">
                                    <tr id="preview-headers"></tr>
                                </thead>
                                <tbody id="preview-body"></tbody>
                            </table>
                        </div>
                        <div class="text-muted small">
                            Mostrando le prime 5 righe. Totale righe: <span id="total-rows">0</span>
                        </div>
                    </div>
                    
                    <!-- Validation Results -->
                    <div id="validation-results" class="mb-4" style="display: none;">
                        <div class="alert" id="validation-alert">
                            <h6 class="alert-heading" id="validation-title"></h6>
                            <div id="validation-content"></div>
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="d-flex gap-3 pt-3 border-top">
                        <button type="button" class="btn btn-outline-info" id="previewBtn">
                            <i class="bi bi-eye"></i> Anteprima
                        </button>
                        <button type="submit" class="btn btn-success" id="importBtn" disabled>
                            <i class="bi bi-upload"></i> Importa Proposte
                        </button>
                        <a href="{{ url_for('decisions.view_session', session_id=session.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg"></i> Annulla
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Help Section -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-info">
                            <i class="bi bi-question-circle"></i> Come Preparare il File CSV
                        </h6>
                    </div>
                    <div class="card-body">
                        <ol class="mb-0">
                            <li>Apri il file <code>tutte_etichette_raggruppate.csv</code></li>
                            <li>Verifica che contenga le colonne richieste</li>
                            <li>Ogni riga rappresenta una proposta di raggruppamento</li>
                            <li>Le etichette originali devono essere separate da virgole</li>
                            <li>Salva il file in formato CSV UTF-8</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-success">
                            <i class="bi bi-lightbulb"></i> Cosa Succede Dopo l'Importazione
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0">
                            <li>Le proposte vengono create con stato "In Attesa"</li>
                            <li>I partecipanti possono iniziare a votare</li>
                            <li>Le proposte duplicate vengono saltate (se abilitato)</li>
                            <li>Ricevi un riepilogo delle proposte importate</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Example CSV Structure -->
        <div class="card mt-4 border-secondary">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Esempio Struttura CSV
                </h6>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded small"><code>proposed_code,proposed_label,category,original_labels,rationale
AI_TOOLS,Strumenti di Intelligenza Artificiale,Tecnologia,"chatgpt,ai assistant,machine learning",Tutti strumenti basati su AI
SOCIAL_MEDIA,Social Media,Comunicazione,"facebook,twitter,instagram,linkedin",Piattaforme social principali
DEV_TOOLS,Strumenti di Sviluppo,Sviluppo,"vscode,github,docker,kubernetes",Tools per programmatori</code></pre>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="importProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Importazione in Corso</h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                </div>
                <p id="import-status">Elaborazione file CSV...</p>
                <div class="progress">
                    <div class="progress-bar" id="import-progress" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block decision_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('importForm');
    const fileInput = document.getElementById('csv_file');
    const previewBtn = document.getElementById('previewBtn');
    const importBtn = document.getElementById('importBtn');
    const previewSection = document.getElementById('preview-section');
    const validationResults = document.getElementById('validation-results');
    
    let csvData = null;
    
    // File input change handler
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            previewBtn.disabled = false;
            importBtn.disabled = true;
            hidePreview();
        } else {
            previewBtn.disabled = true;
            importBtn.disabled = true;
            hidePreview();
        }
    });
    
    // Preview button handler
    previewBtn.addEventListener('click', function() {
        const file = fileInput.files[0];
        if (!file) {
            DecisionUtils.showToast('Seleziona prima un file CSV', 'warning');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csv = e.target.result;
                csvData = parseCSV(csv);
                showPreview(csvData);
                validateCSV(csvData);
            } catch (error) {
                showValidationError('Errore nella lettura del file: ' + error.message);
            }
        };
        reader.readAsText(file);
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        if (!csvData) {
            e.preventDefault();
            DecisionUtils.showToast('Fai prima l\'anteprima del file CSV', 'warning');
            return;
        }
        
        // Show progress modal
        const progressModal = new bootstrap.Modal(document.getElementById('importProgressModal'));
        progressModal.show();
        
        // Simulate progress (you would update this based on actual server progress)
        simulateProgress();
    });
    
    function parseCSV(csv) {
        const lines = csv.trim().split('\n');
        if (lines.length < 2) {
            throw new Error('Il file deve contenere almeno un header e una riga di dati');
        }
        
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const rows = [];
        
        for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            if (values.length === headers.length) {
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                rows.push(row);
            }
        }
        
        return { headers, rows };
    }
    
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current.trim());
        return result;
    }
    
    function showPreview(data) {
        const { headers, rows } = data;
        
        // Show headers
        const headerRow = document.getElementById('preview-headers');
        headerRow.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
        
        // Show first 5 rows
        const tbody = document.getElementById('preview-body');
        tbody.innerHTML = '';
        
        const previewRows = rows.slice(0, 5);
        previewRows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = headers.map(h => `<td>${row[h] || ''}</td>`).join('');
            tbody.appendChild(tr);
        });
        
        document.getElementById('total-rows').textContent = rows.length;
        previewSection.style.display = 'block';
    }
    
    function validateCSV(data) {
        const { headers, rows } = data;
        const requiredColumns = ['proposed_code', 'proposed_label', 'category', 'original_labels'];
        const missingColumns = requiredColumns.filter(col => !headers.includes(col));
        
        let isValid = true;
        let validationMessages = [];
        
        // Check required columns
        if (missingColumns.length > 0) {
            isValid = false;
            validationMessages.push(`Colonne mancanti: ${missingColumns.join(', ')}`);
        }
        
        // Check data quality
        let emptyRows = 0;
        let duplicateCodes = new Set();
        let codes = new Set();
        
        rows.forEach((row, index) => {
            const code = row.proposed_code;
            const label = row.proposed_label;
            
            if (!code || !label) {
                emptyRows++;
            }
            
            if (code) {
                if (codes.has(code)) {
                    duplicateCodes.add(code);
                }
                codes.add(code);
            }
        });
        
        if (emptyRows > 0) {
            validationMessages.push(`${emptyRows} righe con dati mancanti saranno saltate`);
        }
        
        if (duplicateCodes.size > 0) {
            validationMessages.push(`Codici duplicati trovati: ${Array.from(duplicateCodes).join(', ')}`);
        }
        
        // Show validation results
        showValidationResults(isValid, validationMessages, rows.length - emptyRows);
        
        // Enable import button if valid
        importBtn.disabled = !isValid;
    }
    
    function showValidationResults(isValid, messages, validRows) {
        const alert = document.getElementById('validation-alert');
        const title = document.getElementById('validation-title');
        const content = document.getElementById('validation-content');
        
        if (isValid) {
            alert.className = 'alert alert-success';
            title.innerHTML = '<i class="bi bi-check-circle"></i> Validazione Completata';
            content.innerHTML = `
                <p>Il file CSV è valido e pronto per l'importazione.</p>
                <ul>
                    <li><strong>${validRows}</strong> proposte saranno importate</li>
                    ${messages.length > 0 ? '<li>' + messages.join('</li><li>') + '</li>' : ''}
                </ul>
            `;
        } else {
            alert.className = 'alert alert-danger';
            title.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Errori di Validazione';
            content.innerHTML = `
                <p>Correggi i seguenti errori prima di procedere:</p>
                <ul><li>${messages.join('</li><li>')}</li></ul>
            `;
        }
        
        validationResults.style.display = 'block';
    }
    
    function showValidationError(message) {
        showValidationResults(false, [message], 0);
    }
    
    function hidePreview() {
        previewSection.style.display = 'none';
        validationResults.style.display = 'none';
        csvData = null;
    }
    
    function simulateProgress() {
        const progressBar = document.getElementById('import-progress');
        const statusText = document.getElementById('import-status');
        
        let progress = 0;
        const steps = [
            'Validazione file CSV...',
            'Creazione proposte...',
            'Verifica duplicati...',
            'Finalizzazione importazione...'
        ];
        
        const interval = setInterval(() => {
            progress += 25;
            progressBar.style.width = progress + '%';
            
            const stepIndex = Math.floor(progress / 25) - 1;
            if (stepIndex >= 0 && stepIndex < steps.length) {
                statusText.textContent = steps[stepIndex];
            }
            
            if (progress >= 100) {
                clearInterval(interval);
                statusText.textContent = 'Importazione completata!';
                
                // Close modal and redirect after a delay
                setTimeout(() => {
                    window.location.href = "{{ url_for('decisions.view_session', session_id=session.id) }}";
                }, 1500);
            }
        }, 800);
    }
});
</script>
{% endblock %}
