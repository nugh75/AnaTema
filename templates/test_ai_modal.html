<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Test Modal Configurazione AI</h1>
        
        <!-- Pulsante per aprire il modal -->
        <button id="ai-config-btn" class="btn btn-primary">
            <i class="bi bi-gear"></i> Configura AI
        </button>
        
        <!-- Modal -->
        <div class="modal fade" id="aiConfigModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Configurazione AI</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="template-select" class="form-label">Template:</label>
                            <select id="template-select" class="form-select">
                                <option value="">Caricamento in corso...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="config-select" class="form-label">Configurazione:</label>
                            <select id="config-select" class="form-select">
                                <option value="">Caricamento in corso...</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                        <button type="button" class="btn btn-primary" id="apply-ai-config">Applica</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Area di debug -->
        <div class="mt-5">
            <h3>Debug Log:</h3>
            <div id="debug-log" style="background-color: #000; color: #0f0; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap; height: 400px; overflow-y: auto;">
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funzione di logging
        function log(message) {
            const logArea = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }
        
        // Funzione per caricare template e configurazioni
        async function loadAIConfigurations() {
            try {
                log('‚è≥ Inizio caricamento template e configurazioni...');
                
                // Carica template
                log('üì° Chiamata GET /ai/templates...');
                const templatesRes = await fetch('/ai/templates');
                log(`üì° Risposta template: ${templatesRes.status} ${templatesRes.statusText}`);
                
                if (!templatesRes.ok) {
                    const errorText = await templatesRes.text();
                    throw new Error(`HTTP error! status: ${templatesRes.status}, message: ${errorText}`);
                }
                
                const templatesData = await templatesRes.json();
                log(`‚úÖ Ricevuti ${templatesData.templates ? templatesData.templates.length : 0} template`);
                
                const templateSelect = document.getElementById('template-select');
                if (!templateSelect) {
                    throw new Error('Elemento template-select non trovato nel DOM');
                }
                
                templateSelect.innerHTML = '<option value="">Seleziona un template...</option>';
                
                if (templatesData.success && templatesData.templates) {
                    templatesData.templates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.id;
                        option.textContent = `${template.name} (${template.category})`;
                        templateSelect.appendChild(option);
                        log(`   + Aggiunto template: ${template.name}`);
                    });
                }
                
                // Carica configurazioni
                log('üì° Chiamata GET /ai/configurations...');
                const configsRes = await fetch('/ai/configurations');
                log(`üì° Risposta configurazioni: ${configsRes.status} ${configsRes.statusText}`);
                
                if (!configsRes.ok) {
                    const errorText = await configsRes.text();
                    throw new Error(`HTTP error! status: ${configsRes.status}, message: ${errorText}`);
                }
                
                const configsData = await configsRes.json();
                log(`‚úÖ Ricevute ${configsData.configurations ? configsData.configurations.length : 0} configurazioni`);
                
                const configSelect = document.getElementById('config-select');
                if (!configSelect) {
                    throw new Error('Elemento config-select non trovato nel DOM');
                }
                
                configSelect.innerHTML = '<option value="">Seleziona una configurazione...</option>';
                
                if (configsData.success && configsData.configurations) {
                    configsData.configurations.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.id;
                        option.textContent = `${config.name} (${config.provider})`;
                        if (config.is_active) {
                            option.textContent += ' ‚úÖ';
                            option.selected = true;
                        }
                        configSelect.appendChild(option);
                        log(`   + Aggiunta config: ${config.name}`);
                    });
                }
                
                log('‚úÖ Caricamento completato con successo!');
                return true;
                
            } catch (error) {
                log(`‚ùå ERRORE: ${error.message}`);
                console.error('Errore dettagliato:', error);
                throw error;
            }
        }
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Pagina caricata, inizializzazione...');
            
            const aiConfigBtn = document.getElementById('ai-config-btn');
            const aiConfigModal = document.getElementById('aiConfigModal');
            
            if (aiConfigBtn && aiConfigModal) {
                const modalInstance = new bootstrap.Modal(aiConfigModal);
                
                aiConfigBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    log('üîß Click su pulsante configurazione AI');
                    
                    try {
                        await loadAIConfigurations();
                        modalInstance.show();
                        log('‚úÖ Modal aperto');
                    } catch (error) {
                        log(`‚ùå Errore apertura modal: ${error.message}`);
                        alert('Errore nel caricamento delle configurazioni AI');
                    }
                });
            } else {
                log('‚ùå Elementi non trovati nel DOM');
            }
        });
    </script>
</body>
</html>