{% extends "base.html" %}

{% block title %}Statistiche Quesito - {{ question }}{% endblock %}

{% block extra_css %}
<style>
/* Stili per i filtri delle etichette */
.card-body.border-bottom {
    background-color: #f8f9fa !important;
}

.label-badge {
    transition: all 0.3s ease;
}

.label-badge:hover {
    transform: scale(1.05);
}

#label-filters-form .form-control:focus,
#label-filters-form .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn-group .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* Stili per i filtri dei grafici - PROTETTI */
.chart-filters-container {
    position: relative;
    z-index: 1000;
    border: 2px solid #0dcaf0 !important;
    box-shadow: 0 2px 8px rgba(13, 202, 240, 0.15);
    background: white !important;
    opacity: 1 !important;
    display: block !important;
    visibility: visible !important;
}

.chart-filters-container .card-header {
    background-color: #0dcaf0 !important;
    color: white !important;
    border-bottom: 1px solid #0dcaf0 !important;
}

.chart-filters-container .card-body {
    background-color: #ffffff !important;
    padding: 1rem !important;
}

/* Protezione anti-rimozione automatica */
.chart-filters-container,
.chart-filters-container * {
    transition: none !important;
    animation: none !important;
}

/* Override per evitare interferenze */
.chart-filters-container.alert {
    display: block !important;
    opacity: 1 !important;
}

/* Stili per i grafici */
.chart-container {
    position: relative;
    width: 100%;
    height: 400px;
    margin: 10px 0;
}

.nav-tabs .nav-link {
    color: #6c757d;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #0d6efd;
    color: #0d6efd;
}

.nav-tabs .nav-link.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.tab-content {
    padding: 20px 0;
}

/* Stili per le legende personalizzate */
.chart-legend {
    max-height: 300px;
    overflow-y: auto;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    padding: 4px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.legend-item:hover {
    background-color: #f8f9fa;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    margin-right: 8px;
    flex-shrink: 0;
}

.legend-text {
    font-size: 0.875rem;
    flex-grow: 1;
}

.legend-value {
    font-weight: bold;
    font-size: 0.8rem;
    color: #6c757d;
}

/* Responsive charts */
@media (max-width: 768px) {
    .chart-container {
        height: 300px;
    }
    
    .nav-tabs .nav-link {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
}

/* Loading spinner per i grafici */
.chart-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    color: #6c757d;
}

.chart-loading .spinner-border {
    width: 3rem;
    height: 3rem;
}

/* Animazioni per i tab */
.tab-pane {
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

.tab-pane.show.active {
    opacity: 1;
}

/* Stili per il contenuto delle celle */
.cell-content {
    text-align: left !important;
    text-indent: 0 !important;
    margin-left: 0 !important;
    padding-left: 0 !important;
    display: block !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* Stili specifici per la tabella Annotazioni per Cella */
.table table-sm table-hover td {
    text-align: left !important;
    padding-left: 0.5rem !important;
}

/* Override più specifico per la colonna Contenuto */
.table.table-sm.table-hover td:nth-child(2) {
    text-align: left !important;
    padding-left: 0.25rem !important;
    vertical-align: top !important;
}

/* Override ancora più specifico per forzare l'allineamento */
.table.table-sm.table-hover td:nth-child(2) .cell-content {
    text-align: left !important;
    margin: 0 !important;
    padding: 0 !important;
    text-indent: 0 !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    word-break: break-all !important;
    overflow-wrap: break-word !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2><i class="bi bi-question-circle me-2"></i>Quesito: {{ question }}</h2>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('statistics.question_compare', file_id=file.id, question=question) }}" 
                       class="btn btn-success">
                        <i class="bi bi-people"></i> Confronta Annotatori
                    </a>
                    <a href="{{ url_for('statistics.file_detail', file_id=file.id) }}" 
                       class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Torna al File
                    </a>
                </div>
            </div>

            <!-- Pulsanti per export report completo -->
            <div class="d-flex justify-content-center mb-4">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="exportCompleteReport('csv')" title="Scarica report completo in CSV">
                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="exportCompleteReport('excel')" title="Scarica report completo in Excel">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="exportCompleteReport('word')" title="Scarica report completo in Word">
                        <i class="bi bi-file-earmark-word"></i> Word
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="exportCompleteReport('pdf')" title="Scarica report completo in PDF">
                        <i class="bi bi-file-earmark-pdf"></i> PDF
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="exportCompleteReport('text')" title="Scarica report completo in TXT">
                        <i class="bi bi-file-earmark-text"></i> TXT
                    </button>
                </div>
            </div>

            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('statistics.overview') }}">Statistiche</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('statistics.file_detail', file_id=file.id) }}">{{ file.filename }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ question }}</li>
                </ol>
            </nav>

            <!-- Statistiche Generali -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h3 class="text-primary">{{ cells|length }}</h3>
                            <p class="mb-0">Celle Totali</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h3 class="text-success">{{ cells_with_annotations|length }}</h3>
                            <p class="mb-0">Celle Annotate</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h3 class="text-info">{{ annotator_stats|length }}</h3>
                            <p class="mb-0">Annotatori</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h3 class="text-warning">{{ label_stats|length }}</h3>
                            <p class="mb-0">Etichette</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grafici e Visualizzazioni -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-bar-chart me-2"></i>Visualizzazioni Grafiche
                                <small class="text-muted">(Analisi visiva dei dati)</small>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Filtri per i grafici -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="card border-info chart-filters-container">
                                        <div class="card-header bg-info text-white py-2">
                                            <h6 class="mb-0">
                                                <i class="bi bi-funnel me-1"></i>Filtri per Grafici
                                                <small class="ms-2">- Applicano a tutte le visualizzazioni</small>
                                            </h6>
                                        </div>
                                        <div class="card-body py-3">
                                            <div class="row g-2 align-items-end">
                                                <div class="col-md-3">
                                                    <label for="chart-category-filter" class="form-label small mb-1">
                                                        <strong>Categoria:</strong>
                                                    </label>
                                                    <select class="form-select form-select-sm" id="chart-category-filter">
                                                        <option value="">Tutte le categorie</option>
                                                        {% for category in available_categories %}
                                                        <option value="{{ category }}">{{ category }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="chart-label-filter" class="form-label small mb-1">
                                                        <strong>Etichetta:</strong>
                                                    </label>
                                                    <input type="text" class="form-control form-control-sm" 
                                                           id="chart-label-filter" placeholder="Cerca etichetta...">
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="chart-min-usage" class="form-label small mb-1">
                                                        <strong>Min Utilizzi:</strong>
                                                    </label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           id="chart-min-usage" min="1" placeholder="1">
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="chart-max-usage" class="form-label small mb-1">
                                                        <strong>Max Utilizzi:</strong>
                                                    </label>
                                                    <input type="number" class="form-control form-control-sm" 
                                                           id="chart-max-usage" min="1" placeholder="∞">
                                                </div>
                                                <div class="col-md-2">
                                                    <div class="d-flex gap-1">
                                                        <button type="button" class="btn btn-primary btn-sm flex-fill" 
                                                                id="update-charts-btn" onclick="updateAllCharts()" 
                                                                title="Applica filtri ai grafici">
                                                            <i class="bi bi-arrow-clockwise"></i> Aggiorna
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                                onclick="resetChartFilters()" title="Reset filtri">
                                                            <i class="bi bi-x-circle"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-12 text-center">
                                                    <small class="text-muted">
                                                        <i class="bi bi-info-circle me-1"></i>
                                                        I filtri si applicano a tutti i grafici. Usa "Aggiorna" per applicare le modifiche.
                                                        <span id="chart-filter-status" class="ms-2"></span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tabs per i diversi grafici -->
                            <ul class="nav nav-tabs mb-3" id="chartsTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="labels-chart-tab" data-bs-toggle="tab" data-bs-target="#labels-chart" type="button" role="tab">
                                        <i class="bi bi-bar-chart-fill me-1"></i>Etichette
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="annotators-chart-tab" data-bs-toggle="tab" data-bs-target="#annotators-chart" type="button" role="tab">
                                        <i class="bi bi-people-fill me-1"></i>Annotatori
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="categories-chart-tab" data-bs-toggle="tab" data-bs-target="#categories-chart" type="button" role="tab">
                                        <i class="bi bi-pie-chart-fill me-1"></i>Categorie
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="coverage-chart-tab" data-bs-toggle="tab" data-bs-target="#coverage-chart" type="button" role="tab">
                                        <i class="bi bi-graph-up me-1"></i>Copertura
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="chartsTabContent">
                                <!-- Grafico Etichette -->
                                <div class="tab-pane fade show active" id="labels-chart" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="mb-3">
                                                <i class="bi bi-tags me-1"></i>Istogramma Utilizzo Etichette
                                                <small class="text-muted">- Frequenza di utilizzo per ogni etichetta</small>
                                            </h6>
                                            <div class="chart-container" style="height: 400px;">
                                                <canvas id="labelsHistogramChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="mb-3">
                                                <i class="bi bi-info-circle me-1"></i>Informazioni
                                            </h6>
                                            <div class="alert alert-info">
                                                <small>
                                                    <strong>Cosa mostra:</strong><br>
                                                    • Numero di utilizzi per ogni etichetta<br>
                                                    • I colori rappresentano le etichette originali<br>
                                                    • Ordinamento decrescente per utilizzo
                                                </small>
                                            </div>
                                            <div id="labelsChartLegend" class="mt-3">
                                                <!-- Legenda dinamica -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Grafico Annotatori -->
                                <div class="tab-pane fade" id="annotators-chart" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="mb-3">
                                                <i class="bi bi-people me-1"></i>Confronto Annotatori
                                                <small class="text-muted">- Produttività e copertura per annotatore</small>
                                            </h6>
                                            <div class="chart-container" style="height: 400px;">
                                                <canvas id="annotatorsHistogramChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="mb-3">
                                                <i class="bi bi-info-circle me-1"></i>Metriche
                                            </h6>
                                            <div class="alert alert-info">
                                                <small>
                                                    <strong>Barre blu:</strong> Totale annotazioni<br>
                                                    <strong>Barre verdi:</strong> Celle uniche annotate<br>
                                                    <strong>Rapporto:</strong> Intensità di annotazione per cella
                                                </small>
                                            </div>
                                            <div id="annotatorsStats" class="mt-3">
                                                <!-- Statistiche dinamiche -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Grafico Categorie -->
                                <div class="tab-pane fade" id="categories-chart" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6 class="mb-3">
                                                <i class="bi bi-collection me-1"></i>Distribuzione per Categoria
                                                <small class="text-muted">- Raggruppamento tematico delle annotazioni</small>
                                            </h6>
                                            <div class="chart-container" style="height: 400px;">
                                                <canvas id="categoriesDistributionChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="mb-3">
                                                <i class="bi bi-pie-chart me-1"></i>Riassunto
                                            </h6>
                                            <div class="alert alert-success">
                                                <small>
                                                    <strong>Vista d'insieme:</strong><br>
                                                    • Distribuzione per categoria tematica<br>
                                                    • Identificazione dei temi predominanti<br>
                                                    • Bilanciamento delle annotazioni
                                                </small>
                                            </div>
                                            <div id="categoriesStats" class="mt-3">
                                                <!-- Statistiche categorie -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Grafico Copertura -->
                                <div class="tab-pane fade" id="coverage-chart" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="mb-3">
                                                <i class="bi bi-speedometer2 me-1"></i>Copertura Annotazioni
                                            </h6>
                                            <div class="chart-container" style="height: 300px;">
                                                <canvas id="coverageOverviewChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="mb-3">
                                                <i class="bi bi-graph-up me-1"></i>Distribuzione Intensità
                                            </h6>
                                            <div class="chart-container" style="height: 300px;">
                                                <canvas id="coverageDistributionChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mt-3">
                                            <div class="alert alert-warning">
                                                <small>
                                                    <strong>Analisi Copertura:</strong> 
                                                    Mostra quante celle sono state annotate e con quale intensità. 
                                                    Una buona copertura indica completezza del lavoro di annotazione.
                                                </small>
                                            </div>
                                            <div id="coverageStats" class="row text-center">
                                                <!-- Statistiche copertura -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiche Annotatori -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-people me-2"></i>Annotatori
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Annotatore</th>
                                            <th>Annotazioni</th>
                                            <th>Celle</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in annotator_stats %}
                                        <tr>
                                            <td>{{ user.username }}</td>
                                            <td>{{ user.annotation_count }}</td>
                                            <td>{{ user.cell_count }}</td>
                                            <td>
                                                <a href="{{ url_for('statistics.user_detail', user_id=user.id) }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye"></i> Dettagli
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tutte le Etichette del Quesito -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-tags me-2"></i>Tutte le Etichette del Quesito
                                <small class="text-muted">(Resoconto completo)</small>
                            </h5>
                        </div>
                        
                        <!-- Sezione Filtri -->
                        <div class="card-body border-bottom bg-light">
                            <form method="GET" class="row g-2" id="label-filters-form">
                                <div class="col-md-3">
                                    <label for="category-filter" class="form-label small mb-1">Categoria</label>
                                    <select class="form-select form-select-sm" name="category" id="category-filter">
                                        <option value="">Tutte le categorie</option>
                                        {% for category in available_categories %}
                                        <option value="{{ category }}" 
                                                {% if current_filters.category == category %}selected{% endif %}>
                                            {{ category }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-md-3">
                                    <label for="label-name-filter" class="form-label small mb-1">Nome Etichetta</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           name="label_name" id="label-name-filter"
                                           value="{{ current_filters.label_name or '' }}"
                                           placeholder="Cerca etichetta...">
                                </div>
                                
                                <div class="col-md-2">
                                    <label for="min-usage-filter" class="form-label small mb-1">Min Utilizzi</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           name="min_usage" id="min-usage-filter"
                                           value="{{ current_filters.min_usage or '' }}"
                                           min="{{ min_usage_available }}" max="{{ max_usage_available }}"
                                           placeholder="{{ min_usage_available }}">
                                </div>
                                
                                <div class="col-md-2">
                                    <label for="max-usage-filter" class="form-label small mb-1">Max Utilizzi</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           name="max_usage" id="max-usage-filter"
                                           value="{{ current_filters.max_usage or '' }}"
                                           min="{{ min_usage_available }}" max="{{ max_usage_available }}"
                                           placeholder="{{ max_usage_available }}">
                                </div>
                                
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">&nbsp;</label>
                                    <div class="d-flex gap-1">
                                        <button type="submit" class="btn btn-primary btn-sm" title="Applica filtri">
                                            <i class="bi bi-funnel"></i>
                                        </button>
                                        <a href="{{ url_for('statistics.question_detail', file_id=file.id, question=question) }}" 
                                           class="btn btn-outline-secondary btn-sm" title="Reset filtri">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Ordinamento -->
                                <div class="col-12">
                                    <div class="d-flex gap-2 align-items-center">
                                        <small class="text-muted">Ordina per:</small>
                                        <select class="form-select form-select-sm" name="sort_by" style="width: auto;" onchange="this.form.submit()">
                                            <option value="name" {% if current_filters.sort_by == 'name' %}selected{% endif %}>Nome</option>
                                            <option value="category" {% if current_filters.sort_by == 'category' %}selected{% endif %}>Categoria</option>
                                            <option value="usage" {% if current_filters.sort_by == 'usage' %}selected{% endif %}>Utilizzi</option>
                                        </select>
                                        <select class="form-select form-select-sm" name="sort_order" style="width: auto;" onchange="this.form.submit()">
                                            <option value="asc" {% if current_filters.sort_order == 'asc' %}selected{% endif %}>Crescente</option>
                                            <option value="desc" {% if current_filters.sort_order == 'desc' %}selected{% endif %}>Decrescente</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card-body">
                            <!-- Statistiche dei risultati filtrati -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Visualizzate {{ label_stats|length }} etichette
                                        {% if current_filters.category or current_filters.label_name or current_filters.min_usage or current_filters.max_usage %}
                                        <span class="badge bg-secondary ms-1">Filtrate</span>
                                        {% endif %}
                                    </small>
                                    {% if label_stats %}
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportLabelsCSV()" title="Esporta in CSV">
                                            <i class="bi bi-download"></i> CSV
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleHighlight()" title="Evidenzia termini cercati">
                                            <i class="bi bi-highlighter"></i>
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-sm" id="labels-table">
                                    <thead>
                                        <tr>
                                            <th>Etichetta</th>
                                            <th>Categoria</th>
                                            <th>Utilizzi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for label in label_stats %}
                                        <tr class="label-row" data-label-name="{{ label.name|lower }}" data-category="{{ (label.category_name or '')|lower }}">
                                            <td>
                                                <span class="badge label-badge" style="background-color: {{ label.color }}" data-label="{{ label.name }}">
                                                    {{ label.name }}
                                                </span>
                                            </td>
                                            <td>{{ label.category_name or 'Senza categoria' }}</td>
                                            <td>
                                                <strong>{{ label.usage_count }}</strong>
                                                <small class="text-muted ms-1">utilizzi</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if label_stats %}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Totale etichette trovate: {{ label_stats|length }}
                                </small>
                            </div>
                            {% else %}
                            <div class="text-center py-3">
                                <i class="bi bi-search text-muted"></i>
                                <p class="text-muted mb-0">Nessuna etichetta trovata con i filtri applicati</p>
                                <a href="{{ url_for('statistics.question_detail', file_id=file.id, question=question) }}" 
                                   class="btn btn-sm btn-outline-primary mt-2">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Reset Filtri
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Etichette con Commenti -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-chat-text me-2"></i>Report Completo - Etichette con Tutti i Commenti
                                <small class="text-muted">(Resoconto dettagliato per ogni etichetta)</small>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if labels_with_comments %}
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Questo è il resoconto completo di tutte le etichette utilizzate per questo quesito.</strong>
                                <br>
                                Ogni etichetta mostra tutti i commenti dove è stata applicata con il numero del rispondente (#).
                                <br>
                                <small class="text-muted">
                                    Totale etichette: {{ labels_with_comments|length }} | 
                                    Totale commenti: {{ labels_with_comments.values()|map('length')|sum }}
                                </small>
                            </div>
                            
                            <!-- Lista delle etichette con commenti -->
                            {% for label_name, comments in labels_with_comments.items() %}
                            <div class="mb-4">
                                <h6>
                                    <span class="badge me-2" style="background-color: {{ comments[0].color }}">
                                        {{ label_name }}
                                    </span>
                                    <span class="text-muted">({{ comments|length }} commenti)</span>
                                    {% if comments[0].category_name %}
                                    <small class="text-muted ms-2">
                                        - Categoria: {{ comments[0].category_name }}
                                    </small>
                                    {% endif %}
                                </h6>
                                
                                <ul class="list-unstyled ms-3">
                                    {% for comment in comments %}
                                    <li class="mb-2">
                                        <div class="d-flex">
                                            <div class="me-2">
                                                <strong class="text-primary">#{{ comment.row_number }}</strong>
                                            </div>
                                            <div class="flex-grow-1">
                                                {{ comment.content }}
                                                {% if comment.is_ai_generated %}
                                                <small class="text-info ms-2">
                                                    🤖 AI
                                                    {% if comment.ai_confidence %}
                                                    ({{ "%.0f"|format(comment.ai_confidence * 100) }}%)
                                                    {% endif %}
                                                </small>
                                                {% endif %}
                                                {% if comment.annotator %}
                                                <small class="text-muted ms-2">
                                                    - {{ comment.annotator }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Nessuna etichetta trovata per questo quesito.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Annotazioni per Cella -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-table me-2"></i>Annotazioni per Cella
                                <small class="text-muted">(Raggruppamento Etichetta + AI Info con ID)</small>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID Cella</th>
                                            <th>Contenuto</th>
                                            <th>Annotazioni</th>
                                            <th>Annotatori</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cell_id, annotations in cells_with_annotations.items() %}
                                        <tr>
                                            <td><code>{{ cell_id }}</code></td>
                                            <td style="min-width: 300px; max-width: 500px; text-align: left !important; padding-left: 0.25rem !important;">
                                                {% set cell_content = annotations[0].content %}
                                                <div class="cell-content" style="white-space: normal; word-wrap: break-word; word-break: break-all; text-align: left !important; direction: ltr !important;">
                                                    {{ cell_content|trim }}
                                                </div>
                                            </td>
                                            <td>
                                                {% for ann in annotations %}
                                                <div class="mb-1">
                                                    <span class="badge me-1" 
                                                          style="background-color: {{ ann.label_color }}">
                                                        {{ ann.label_name }}
                                                    </span>
                                                    <small class="text-muted">(ID: {{ ann.annotation_id }})</small>
                                                    {% if ann.is_ai_generated %}
                                                    <br>
                                                    <small class="text-info">🤖 AI Generated 
                                                        {% if ann.ai_confidence %}
                                                        - {{ "%.0f"|format(ann.ai_confidence * 100) }}%
                                                        {% endif %}
                                                    </small>
                                                    {% endif %}
                                                    {% if ann.status != 'active' %}
                                                    <br>
                                                    <small class="text-warning">Status: {{ ann.status }}</small>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for ann in annotations %}
                                                <small class="d-block">{{ ann.annotator }}</small>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('annotation.annotate_cell', cell_id=cell_id) }}" 
                                                   class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="bi bi-pencil"></i> Modifica
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Funzionalità avanzate per i filtri delle etichette

// Variabile per lo stato di evidenziazione
let highlightEnabled = false;

// Export CSV delle etichette filtrate
function exportLabelsCSV() {
    const table = document.getElementById('labels-table');
    const rows = table.querySelectorAll('tbody tr:not([style*="display: none"])');
    
    if (rows.length === 0) {
        alert('Nessuna etichetta da esportare!');
        return;
    }
    
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Etichetta,Categoria,Utilizzi\n";
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const labelName = cells[0].querySelector('.label-badge').textContent.trim();
        const category = cells[1].textContent.trim();
        const usage = cells[2].querySelector('strong').textContent.trim();
        
        csvContent += `"${labelName}","${category}","${usage}"\n`;
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "etichette_quesito_{{ question|replace(' ', '_') }}_{{ file.filename|replace('.xlsx', '') }}.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Export report completo in vari formati
function exportCompleteReport(format) {
    // Dati per il report
    const reportData = {
        question: "{{ question }}",
        filename: "{{ file.filename }}",
        stats: {
            totalCells: {{ cells|length }},
            annotatedCells: {{ cells_with_annotations|length }},
            annotators: {{ annotator_stats|length }},
            labels: {{ label_stats|length }}
        },
        annotators: [
            {% for user in annotator_stats %}
            {
                username: "{{ user.username }}",
                annotationCount: {{ user.annotation_count }},
                cellCount: {{ user.cell_count }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        labels: [
            {% for label in label_stats %}
            {
                name: "{{ label.name }}",
                category: "{{ label.category_name or 'Senza categoria' }}",
                usage: {{ label.usage_count }},
                color: "{{ label.color or '#007bff' }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        labelsWithComments: {
            {% for label_name, comments in labels_with_comments.items() %}
            "{{ label_name }}": [
                {% for comment in comments %}
                {
                    rowNumber: {{ comment.row_number }},
                    content: {{ comment.content|tojson }},
                    isAiGenerated: {{ comment.is_ai_generated|tojson }},
                    aiConfidence: {{ comment.ai_confidence or 'null' }},
                    annotator: "{{ comment.annotator or '' }}",
                    categoryName: "{{ comment.category_name or '' }}",
                    color: "{{ comment.color or '' }}"
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]{% if not loop.last %},{% endif %}
            {% endfor %}
        },
        annotations: [
            {% for cell_id, annotations in cells_with_annotations.items() %}
            {
                cellId: "{{ cell_id }}",
                content: {{ annotations[0].content|tojson }},
                annotations: [
                    {% for ann in annotations %}
                    {
                        annotationId: {{ ann.annotation_id }},
                        labelName: "{{ ann.label_name }}",
                        labelColor: "{{ ann.label_color }}",
                        annotator: "{{ ann.annotator }}",
                        isAiGenerated: {{ ann.is_ai_generated|tojson }},
                        aiConfidence: {{ ann.ai_confidence or 'null' }},
                        status: "{{ ann.status or 'active' }}"
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    switch(format) {
        case 'csv':
            exportToCSV(reportData);
            break;
        case 'excel':
            exportToExcel(reportData);
            break;
        case 'word':
            exportToWord(reportData);
            break;
        case 'pdf':
            exportToPDF(reportData);
            break;
        case 'text':
            exportToText(reportData);
            break;
        default:
            alert('Formato non supportato');
    }
}

// Export CSV completo
function exportToCSV(data) {
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Header del report
    csvContent += `"Report Completo - ${data.question}"\n`;
    csvContent += `"File: ${data.filename}"\n`;
    csvContent += `"Data: ${new Date().toLocaleDateString('it-IT')}"\n\n`;
    
    // Statistiche generali
    csvContent += "Statistiche Generali\n";
    csvContent += "Tipo,Valore\n";
    csvContent += `"Celle Totali",${data.stats.totalCells}\n`;
    csvContent += `"Celle Annotate",${data.stats.annotatedCells}\n`;
    csvContent += `"Annotatori",${data.stats.annotators}\n`;
    csvContent += `"Etichette",${data.stats.labels}\n\n`;
    
    // Annotatori
    csvContent += "Annotatori\n";
    csvContent += "Username,Annotazioni,Celle\n";
    data.annotators.forEach(user => {
        csvContent += `"${user.username}",${user.annotationCount},${user.cellCount}\n`;
    });
    csvContent += "\n";
    
    // Etichette
    csvContent += "Tutte le Etichette del Quesito\n";
    csvContent += "Nome,Categoria,Utilizzi\n";
    data.labels.forEach(label => {
        csvContent += `"${label.name}","${label.category}",${label.usage}\n`;
    });
    csvContent += "\n";
    
    // Report Etichette con Commenti
    csvContent += "Report Completo - Etichette con Tutti i Commenti\n";
    csvContent += "Etichetta,Categoria,Numero Rispondente,Contenuto Commento,AI Generated,AI Confidence,Annotatore\n";
    Object.entries(data.labelsWithComments).forEach(([labelName, comments]) => {
        comments.forEach(comment => {
            const aiGen = comment.isAiGenerated ? 'Sì' : 'No';
            const aiConf = comment.aiConfidence ? `${Math.round(comment.aiConfidence * 100)}%` : '';
            csvContent += `"${labelName}","${comment.categoryName}","#${comment.rowNumber}","${comment.content.replace(/"/g, '""')}","${aiGen}","${aiConf}","${comment.annotator}"\n`;
        });
    });
    csvContent += "\n";
    
    // Annotazioni per Cella
    csvContent += "Annotazioni per Cella\n";
    csvContent += "ID Cella,Contenuto,Etichetta,Annotatore,AI Generated,AI Confidence,Status,Annotation ID\n";
    data.annotations.forEach(cell => {
        cell.annotations.forEach(ann => {
            const aiGen = ann.isAiGenerated ? 'Sì' : 'No';
            const aiConf = ann.aiConfidence ? `${Math.round(ann.aiConfidence * 100)}%` : '';
            csvContent += `"${cell.cellId}","${cell.content.replace(/"/g, '""')}","${ann.labelName}","${ann.annotator}","${aiGen}","${aiConf}","${ann.status}","${ann.annotationId}"\n`;
        });
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `report_completo_${data.question.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Export Excel (utilizzerà CSV per semplicità, ma con estensione xlsx per aprire in Excel)
function exportToExcel(data) {
    exportToCSV(data);
    // Nota: per un vero export Excel si dovrebbe usare una libreria come SheetJS
    alert('File CSV generato (apribile con Excel)');
}

// Export Word (HTML che si apre in Word)
function exportToWord(data) {
    let htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Report Completo - ${data.question}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 15px; font-size: 11px; }
                h1, h2 { color: #2c3e50; }
                h1 { font-size: 16px; margin-bottom: 10px; }
                h2 { font-size: 13px; margin-bottom: 8px; margin-top: 15px; }
                h3 { font-size: 11px; margin-bottom: 5px; margin-top: 10px; }
                table { border-collapse: collapse; width: 100%; margin: 12px 0; font-size: 10px; }
                th, td { border: 1px solid #ddd; padding: 4px; text-align: left; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .stats-box { background-color: #f8f9fa; padding: 10px; margin: 8px 0; border-radius: 3px; font-size: 10px; }
                .badge { color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: bold; }
                .ai-badge { background-color: #17a2b8; }
                ul { margin: 5px 0; padding-left: 15px; }
                li { margin-bottom: 3px; font-size: 10px; }
                p { margin: 3px 0; }
            </style>
        </head>
        <body>
            <h1>Report Completo - ${data.question}</h1>
            <p><strong>File:</strong> ${data.filename}</p>
            <p><strong>Data:</strong> ${new Date().toLocaleDateString('it-IT')}</p>
            
            <h2>Statistiche Generali</h2>
            <div class="stats-box">
                <p><strong>Celle Totali:</strong> ${data.stats.totalCells}</p>
                <p><strong>Celle Annotate:</strong> ${data.stats.annotatedCells}</p>
                <p><strong>Annotatori:</strong> ${data.stats.annotators}</p>
                <p><strong>Etichette:</strong> ${data.stats.labels}</p>
            </div>
            
            <h2>Annotatori</h2>
            <table>
                <tr><th>Username</th><th>Annotazioni</th><th>Celle</th></tr>
                ${data.annotators.map(user => 
                    `<tr><td>${user.username}</td><td>${user.annotationCount}</td><td>${user.cellCount}</td></tr>`
                ).join('')}
            </table>
            
            <h2>Tutte le Etichette del Quesito</h2>
            <table>
                <tr><th>Etichetta</th><th>Categoria</th><th>Utilizzi</th></tr>
                ${data.labels.map(label => 
                    `<tr><td><span class="badge" style="background-color: ${label.color}">${label.name}</span></td><td>${label.category}</td><td>${label.usage}</td></tr>`
                ).join('')}
            </table>
            
            <h2>Report Completo - Etichette con Tutti i Commenti</h2>
            ${Object.entries(data.labelsWithComments).map(([labelName, comments]) => {
                const labelColor = comments[0].color || '#007bff';
                return `
                <h3><span class="badge" style="background-color: ${labelColor}">${labelName}</span> (${comments.length} commenti)</h3>
                <ul>
                    ${comments.map(comment => `
                        <li>
                            <strong>#${comment.rowNumber}</strong>: ${comment.content}
                            ${comment.isAiGenerated ? '<span class="badge ai-badge">🤖 AI</span>' : ''}
                            ${comment.aiConfidence ? `<small>(${Math.round(comment.aiConfidence * 100)}%)</small>` : ''}
                            ${comment.annotator ? `<small>- ${comment.annotator}</small>` : ''}
                        </li>
                    `).join('')}
                </ul>
            `;}).join('')}
            
            <h2>Annotazioni per Cella</h2>
            <table>
                <tr><th>ID Cella</th><th>Contenuto</th><th>Etichette</th><th>Annotatori</th></tr>
                ${data.annotations.map(cell => `
                    <tr>
                        <td style="font-family: monospace;">${cell.cellId}</td>
                        <td style="max-width: 250px; word-wrap: break-word; font-size: 9px;">${cell.content}</td>
                        <td>
                            ${cell.annotations.map(ann => `
                                <div style="margin-bottom: 2px;">
                                    <span class="badge" style="background-color: ${ann.labelColor}">${ann.labelName}</span>
                                    <small>(ID: ${ann.annotationId})</small>
                                    ${ann.isAiGenerated ? '<span class="badge ai-badge">🤖 AI</span>' : ''}
                                    ${ann.aiConfidence ? `<small>(${Math.round(ann.aiConfidence * 100)}%)</small>` : ''}
                                </div>
                            `).join('')}
                        </td>
                        <td>
                            ${cell.annotations.map(ann => `<div style="font-size: 9px;">${ann.annotator}</div>`).join('')}
                        </td>
                    </tr>
                `).join('')}
            </table>
        </body>
        </html>
    `;
    
    const blob = new Blob([htmlContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `report_completo_${data.question.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// Export PDF (utilizzerà window.print per ora)
function exportToPDF(data) {
    // Apre una nuova finestra con il contenuto formattato per stampa/PDF
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>Report Completo - ${data.question}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 15px; font-size: 9px; line-height: 1.3; }
                h1, h2 { color: #2c3e50; page-break-after: avoid; }
                h1 { font-size: 14px; margin-bottom: 8px; }
                h2 { font-size: 11px; margin-bottom: 6px; margin-top: 12px; }
                h3 { font-size: 10px; margin-bottom: 4px; margin-top: 8px; }
                table { border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 8px; }
                th, td { border: 1px solid #ddd; padding: 3px; text-align: left; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .stats-box { background-color: #f8f9fa; padding: 8px; margin: 6px 0; border-radius: 3px; font-size: 8px; }
                .badge { color: white; padding: 1px 4px; border-radius: 2px; font-size: 7px; font-weight: bold; }
                .ai-badge { background-color: #17a2b8; }
                ul { margin: 3px 0; padding-left: 12px; }
                li { margin-bottom: 2px; font-size: 8px; }
                p { margin: 2px 0; }
                @media print { 
                    body { margin: 8px; font-size: 8px; } 
                    table { page-break-inside: avoid; margin: 5px 0; }
                    tr { page-break-inside: avoid; }
                    h1 { font-size: 12px; }
                    h2 { font-size: 10px; }
                    .stats-box { font-size: 7px; padding: 5px; }
                }
                .cell-content { max-width: 150px; word-wrap: break-word; font-size: 7px; }
            </style>
        </head>
        <body>
            <h1>Report Completo - ${data.question}</h1>
            <p><strong>File:</strong> ${data.filename}</p>
            <p><strong>Data:</strong> ${new Date().toLocaleDateString('it-IT')}</p>
            
            <h2>Statistiche Generali</h2>
            <div class="stats-box">
                <p><strong>Celle Totali:</strong> ${data.stats.totalCells}</p>
                <p><strong>Celle Annotate:</strong> ${data.stats.annotatedCells}</p>
                <p><strong>Annotatori:</strong> ${data.stats.annotators}</p>
                <p><strong>Etichette:</strong> ${data.stats.labels}</p>
            </div>
            
            <h2>Annotatori</h2>
            <table>
                <tr><th>Username</th><th>Annotazioni</th><th>Celle</th></tr>
                ${data.annotators.map(user => 
                    `<tr><td>${user.username}</td><td>${user.annotationCount}</td><td>${user.cellCount}</td></tr>`
                ).join('')}
            </table>
            
            <h2>Tutte le Etichette del Quesito</h2>
            <table>
                <tr><th>Etichetta</th><th>Categoria</th><th>Utilizzi</th></tr>
                ${data.labels.map(label => 
                    `<tr><td><span class="badge" style="background-color: ${label.color}">${label.name}</span></td><td>${label.category}</td><td>${label.usage}</td></tr>`
                ).join('')}
            </table>
            
            <h2>Report Completo - Etichette con Tutti i Commenti</h2>
            ${Object.entries(data.labelsWithComments).map(([labelName, comments]) => {
                const labelColor = comments[0].color || '#007bff';
                return `
                <h3><span class="badge" style="background-color: ${labelColor}">${labelName}</span> (${comments.length} commenti)</h3>
                <table style="margin-left: 15px;">
                    <tr><th>Numero</th><th>Contenuto</th><th>Info</th></tr>
                    ${comments.map(comment => `
                        <tr>
                            <td style="white-space: nowrap;">#${comment.rowNumber}</td>
                            <td class="cell-content">${comment.content}</td>
                            <td style="white-space: nowrap;">
                                ${comment.isAiGenerated ? '<span class="badge ai-badge">🤖</span>' : ''}
                                ${comment.aiConfidence ? `<small>(${Math.round(comment.aiConfidence * 100)}%)</small>` : ''}
                                ${comment.annotator ? `<small>${comment.annotator}</small>` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </table>
            `;}).join('')}
            
            <h2>Annotazioni per Cella</h2>
            <table>
                <tr><th>ID Cella</th><th>Contenuto</th><th>Etichette</th><th>Annotatori</th></tr>
                ${data.annotations.map(cell => `
                    <tr>
                        <td style="font-family: monospace; white-space: nowrap;">${cell.cellId}</td>
                        <td class="cell-content">${cell.content}</td>
                        <td>
                            ${cell.annotations.map(ann => `
                                <div style="margin-bottom: 1px;">
                                    <span class="badge" style="background-color: ${ann.labelColor}">${ann.labelName}</span>
                                    <small>(${ann.annotationId})</small>
                                    ${ann.isAiGenerated ? '<span class="badge ai-badge">🤖</span>' : ''}
                                    ${ann.aiConfidence ? `<small>(${Math.round(ann.aiConfidence * 100)}%)</small>` : ''}
                                </div>
                            `).join('')}
                        </td>
                        <td>
                            ${cell.annotations.map(ann => `<div style="font-size: 7px;">${ann.annotator}</div>`).join('')}
                        </td>
                    </tr>
                `).join('')}
            </table>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Export Text
function exportToText(data) {
    let textContent = `REPORT COMPLETO - ${data.question}\n`;
    textContent += `${'='.repeat(50)}\n\n`;
    textContent += `File: ${data.filename}\n`;
    textContent += `Data: ${new Date().toLocaleDateString('it-IT')}\n\n`;
    
    // Statistiche generali
    textContent += `STATISTICHE GENERALI\n`;
    textContent += `${'-'.repeat(20)}\n`;
    textContent += `Celle Totali: ${data.stats.totalCells}\n`;
    textContent += `Celle Annotate: ${data.stats.annotatedCells}\n`;
    textContent += `Annotatori: ${data.stats.annotators}\n`;
    textContent += `Etichette: ${data.stats.labels}\n\n`;
    
    // Annotatori
    textContent += `ANNOTATORI\n`;
    textContent += `${'-'.repeat(10)}\n`;
    data.annotators.forEach(user => {
        textContent += `${user.username}: ${user.annotationCount} annotazioni, ${user.cellCount} celle\n`;
    });
    textContent += `\n`;
    
    // Etichette
    textContent += `TUTTE LE ETICHETTE DEL QUESITO\n`;
    textContent += `${'-'.repeat(32)}\n`;
    data.labels.forEach(label => {
        textContent += `${label.name} (${label.category}): ${label.usage} utilizzi\n`;
    });
    textContent += `\n`;
    
    // Report Etichette con Commenti
    textContent += `REPORT COMPLETO - ETICHETTE CON TUTTI I COMMENTI\n`;
    textContent += `${'-'.repeat(48)}\n`;
    Object.entries(data.labelsWithComments).forEach(([labelName, comments]) => {
        textContent += `\n${labelName.toUpperCase()} (${comments.length} commenti):\n`;
        textContent += `${'-'.repeat(labelName.length + 15)}\n`;
        comments.forEach(comment => {
            textContent += `#${comment.rowNumber}: ${comment.content}`;
            if (comment.isAiGenerated) {
                textContent += ` [🤖 AI`;
                if (comment.aiConfidence) {
                    textContent += ` ${Math.round(comment.aiConfidence * 100)}%`;
                }
                textContent += `]`;
            }
            if (comment.annotator) {
                textContent += ` - ${comment.annotator}`;
            }
            textContent += `\n`;
        });
    });
    textContent += `\n`;
    
    // Annotazioni per Cella
    textContent += `ANNOTAZIONI PER CELLA\n`;
    textContent += `${'-'.repeat(20)}\n`;
    data.annotations.forEach(cell => {
        textContent += `\nCella ${cell.cellId}:\n`;
        textContent += `Contenuto: ${cell.content}\n`;
        textContent += `Annotazioni:\n`;
        cell.annotations.forEach(ann => {
            textContent += `  - ${ann.labelName} (ID: ${ann.annotationId}) - ${ann.annotator}`;
            if (ann.isAiGenerated) {
                textContent += ` [🤖 AI`;
                if (ann.aiConfidence) {
                    textContent += ` ${Math.round(ann.aiConfidence * 100)}%`;
                }
                textContent += `]`;
            }
            if (ann.status !== 'active') {
                textContent += ` [Status: ${ann.status}]`;
            }
            textContent += `\n`;
        });
    });
    
    const blob = new Blob([textContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `report_completo_${data.question.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// Toggle evidenziazione termini cercati
function toggleHighlight() {
    highlightEnabled = !highlightEnabled;
    const searchTerm = document.getElementById('label-name-filter').value.toLowerCase();
    const badges = document.querySelectorAll('.label-badge');
    
    badges.forEach(badge => {
        if (highlightEnabled && searchTerm) {
            const text = badge.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                badge.style.boxShadow = '0 0 10px #ffc107';
                badge.style.border = '2px solid #ffc107';
            }
        } else {
            badge.style.boxShadow = '';
            badge.style.border = '';
        }
    });
    
    // Cambia icona del pulsante
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    if (highlightEnabled) {
        icon.className = 'bi bi-highlighter-fill';
        btn.classList.add('active');
    } else {
        icon.className = 'bi bi-highlighter';
        btn.classList.remove('active');
    }
}

{% endblock %}

{% block scripts %}
<!-- Chart.js per i grafici -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Funzionalità avanzate per i filtri delle etichette

// Variabile per lo stato di evidenziazione
let highlightEnabled = false;

// Variabili globali per i grafici
let labelsChart, annotatorsChart, categoriesChart, coverageOverviewChart, coverageDistributionChart;

// Inizializzazione al caricamento della pagina
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Inizializzazione grafici statistiche...');
    
    // PROTEZIONE FILTRI: Previeni rimozione automatica
    protectChartFilters();
    
    // Inizializza grafici quando i tab vengono attivati
    const labelsTab = document.getElementById('labels-chart-tab');
    const annotatorsTab = document.getElementById('annotators-chart-tab');
    const categoriesTab = document.getElementById('categories-chart-tab');
    const coverageTab = document.getElementById('coverage-chart-tab');
    
    if (labelsTab) {
        labelsTab.addEventListener('shown.bs.tab', function() {
            console.log('📊 Caricamento grafico etichette...');
            loadLabelsChart();
        });
    }
    
    if (annotatorsTab) {
        annotatorsTab.addEventListener('shown.bs.tab', function() {
            console.log('👥 Caricamento grafico annotatori...');
            loadAnnotatorsChart();
        });
    }
    
    if (categoriesTab) {
        categoriesTab.addEventListener('shown.bs.tab', function() {
            console.log('🏷️ Caricamento grafico categorie...');
            loadCategoriesChart();
        });
    }
    
    if (coverageTab) {
        coverageTab.addEventListener('shown.bs.tab', function() {
            console.log('📈 Caricamento grafici copertura...');
            loadCoverageCharts();
        });
    }
    
    // Aggiungi listener per aggiornamento automatico con Enter
    const chartFilters = document.querySelectorAll('#chart-category-filter, #chart-label-filter, #chart-min-usage, #chart-max-usage');
    chartFilters.forEach(filter => {
        if (!filter) return;
        
        filter.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                console.log('⌨️ Aggiornamento grafici da tastiera');
                updateAllCharts();
            }
        });
        
        // Auto-aggiornamento per select categoria
        if (filter.tagName === 'SELECT' && filter.id === 'chart-category-filter') {
            filter.addEventListener('change', function() {
                console.log('🔄 Auto-aggiornamento da cambio categoria');
                updateAllCharts();
            });
        }
    });
    
    // Inizializza stato filtri
    updateFilterStatus({});
    
    // Protezione aggiuntiva ogni 2 secondi
    setInterval(protectChartFilters, 2000);
    
    // Carica il primo grafico (etichette) dopo un piccolo delay
    setTimeout(() => {
        console.log('🚀 Caricamento iniziale grafico etichette...');
        loadLabelsChart();
    }, 500);
    
    // Setup filtri esistenti
    setupFilters();
    
    console.log('✅ Inizializzazione grafici completata');
});

// FUNZIONE DI PROTEZIONE FILTRI
function protectChartFilters() {
    const container = document.querySelector('.chart-filters-container');
    if (!container) return;
    
    // Assicurati che il container sia sempre visibile
    container.style.display = 'block';
    container.style.opacity = '1';
    container.style.visibility = 'visible';
    
    // Rimuovi eventuali timer di auto-rimozione
    if (container.timeoutId) {
        clearTimeout(container.timeoutId);
        delete container.timeoutId;
    }
    
    // Previeni che venga trattato come alert auto-removibile
    container.classList.remove('alert');
    container.classList.add('alert-permanent');
    
    // Assicurati che tutti i controlli siano presenti
    const requiredElements = [
        '#chart-category-filter',
        '#chart-label-filter', 
        '#chart-min-usage',
        '#chart-max-usage',
        '#update-charts-btn',
        '#chart-filter-status'
    ];
    
    let allPresent = true;
    requiredElements.forEach(selector => {
        if (!document.querySelector(selector)) {
            console.warn(`⚠️ Elemento filtro mancante: ${selector}`);
            allPresent = false;
        }
    });
    
    if (!allPresent) {
        console.error('❌ Alcuni elementi dei filtri sono mancanti, potrebbero essere stati rimossi');
    }
}

// Carica grafico istogramma etichette
function loadLabelsChart() {
    console.log('🔄 loadLabelsChart() chiamata');
    
    if (labelsChart) {
        console.log('🗑️ Distruggendo grafico esistente');
        labelsChart.destroy();
    }
    
    const canvas = document.getElementById('labelsHistogramChart');
    if (!canvas) {
        console.error('❌ Canvas labelsHistogramChart non trovato!');
        return;
    }
    
    console.log('✅ Canvas trovato:', canvas);
    
    const ctx = canvas.getContext('2d');
    
    // Mostra loader
    showChartLoader(ctx);
    
    // Ottieni filtri correnti
    const filters = getCurrentChartFilters();
    
    // Aggiungi il quesito ai parametri
    filters.question = `{{ question|e }}`;
    
    const queryString = new URLSearchParams(filters).toString();
    
    const url = `/statistics/api/question_chart_data/{{ file.id }}/labels_histogram?${queryString}`;
    console.log('🌐 Chiamata API:', url);
    
    fetch(url)
        .then(response => {
            console.log('📡 Risposta ricevuta:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('📊 Dati ricevuti:', data);
            
            if (data.labels.length === 0) {
                console.warn('⚠️ Nessun dato trovato');
                showChartError(ctx, 'Nessun dato trovato con i filtri applicati');
                updateLabelsLegend({labels: [], categories: [], colors: [], values: []});
                return;
            }
            
            labelsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Utilizzi',
                        data: data.values,
                        backgroundColor: data.colors.map(color => color + '80'), // Aggiungi trasparenza
                        borderColor: data.colors,
                        borderWidth: 2,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Frequenza di utilizzo delle etichette ${getFilterDescription()}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const category = data.categories[context.dataIndex];
                                    return [
                                        `Etichetta: ${context.label}`,
                                        `Utilizzi: ${context.parsed.y}`,
                                        `Categoria: ${category}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Numero di utilizzi'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Etichette'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Aggiorna legenda personalizzata
            updateLabelsLegend(data);
        })
        .catch(error => {
            console.error('❌ Errore nel caricamento del grafico etichette:', error);
            showChartError(ctx, `Errore nel caricamento dei dati delle etichette: ${error.message}`);
            updateLabelsLegend({labels: [], categories: [], colors: [], values: []});
        });
}

// Carica grafico annotatori
function loadAnnotatorsChart() {
    console.log('🔄 loadAnnotatorsChart() chiamata');
    
    if (annotatorsChart) {
        console.log('🗑️ Distruggendo grafico annotatori esistente');
        annotatorsChart.destroy();
    }
    
    const canvas = document.getElementById('annotatorsHistogramChart');
    if (!canvas) {
        console.error('❌ Canvas annotatorsHistogramChart non trovato!');
        return;
    }
    
    console.log('✅ Canvas annotatori trovato:', canvas);
    
    const ctx = canvas.getContext('2d');
    showChartLoader(ctx);
    
    // Ottieni filtri correnti
    const filters = getCurrentChartFilters();
    
    // Aggiungi il quesito ai parametri
    filters.question = `{{ question|e }}`;
    
    const queryString = new URLSearchParams(filters).toString();
    
    const url = `/statistics/api/question_chart_data/{{ file.id }}/annotators_histogram?${queryString}`;
    console.log('🌐 Chiamata API annotatori:', url);
    
    fetch(url)
        .then(response => {
            console.log('📡 Risposta annotatori ricevuta:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('📊 Dati annotatori ricevuti:', data);
            
            if (data.labels.length === 0) {
                console.warn('⚠️ Nessun annotatore trovato');
                showChartError(ctx, 'Nessun annotatore trovato con i filtri applicati');
                updateAnnotatorsStats({labels: [], annotations: [], cells: []});
                return;
            }
            
            annotatorsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Totale Annotazioni',
                            data: data.annotations,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Celle Uniche',
                            data: data.cells,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Produttività annotatori ${getFilterDescription()}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const cells = data.cells[context.dataIndex];
                                        const annotations = data.annotations[context.dataIndex];
                                        const ratio = cells > 0 ? (annotations / cells).toFixed(1) : 0;
                                        return `Intensità: ${ratio} annotazioni/cella`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantità'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Annotatori'
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Aggiorna statistiche annotatori
            updateAnnotatorsStats(data);
        })
        .catch(error => {
            console.error('❌ Errore nel caricamento del grafico annotatori:', error);
            showChartError(ctx, `Errore nel caricamento dei dati degli annotatori: ${error.message}`);
            updateAnnotatorsStats({labels: [], annotations: [], cells: []});
        });
}

// Carica grafico categorie
function loadCategoriesChart() {
    if (categoriesChart) {
        categoriesChart.destroy();
    }
    
    const canvas = document.getElementById('categoriesDistributionChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    showChartLoader(ctx);
    
    fetch(`/statistics/api/question_chart_data/{{ file.id }}/categories_distribution?question={{ question|urlencode }}`)
        .then(response => response.json())
        .then(data => {
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
            ];
            
            categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.categories,
                    datasets: [{
                        label: 'Annotazioni',
                        data: data.annotations,
                        backgroundColor: colors.slice(0, data.categories.length),
                        borderColor: colors.slice(0, data.categories.length).map(color => color),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuzione per categoria tematica',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = data.annotations.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    const labelCount = data.labels_count[context.dataIndex];
                                    return [
                                        `${context.label}: ${context.parsed} annotazioni (${percentage}%)`,
                                        `Etichette uniche: ${labelCount}`
                                    ];
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Aggiorna statistiche categorie
            updateCategoriesStats(data);
        })
        .catch(error => {
            console.error('Errore nel caricamento del grafico categorie:', error);
            showChartError(ctx, 'Errore nel caricamento dei dati delle categorie');
        });
}

// Carica grafici di copertura
function loadCoverageCharts() {
    const canvas1 = document.getElementById('coverageOverviewChart');
    const canvas2 = document.getElementById('coverageDistributionChart');
    
    if (!canvas1 || !canvas2) return;
    
    const ctx1 = canvas1.getContext('2d');
    const ctx2 = canvas2.getContext('2d');
    
    showChartLoader(ctx1);
    showChartLoader(ctx2);
    
    fetch(`/statistics/api/question_chart_data/{{ file.id }}/coverage_analysis?question={{ question|urlencode }}`)
        .then(response => response.json())
        .then(data => {
            // Grafico overview copertura
            if (coverageOverviewChart) {
                coverageOverviewChart.destroy();
            }
            
            coverageOverviewChart = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: ['Celle Annotate', 'Celle Non Annotate'],
                    datasets: [{
                        data: [data.annotated_cells, data.unannotated_cells],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderColor: ['#28a745', '#dc3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Copertura: ${data.coverage_percentage.toFixed(1)}%`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / data.total_cells) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} celle (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Grafico distribuzione intensità
            if (coverageDistributionChart) {
                coverageDistributionChart.destroy();
            }
            
            coverageDistributionChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: data.distribution_labels,
                    datasets: [{
                        label: 'Numero di celle',
                        data: data.distribution_values,
                        backgroundColor: 'rgba(255, 193, 7, 0.8)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Intensità di annotazione',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Numero di celle'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Annotazioni per cella'
                            }
                        }
                    }
                }
            });
            
            // Aggiorna statistiche copertura
            updateCoverageStats(data);
        })
        .catch(error => {
            console.error('Errore nel caricamento dei grafici di copertura:', error);
            showChartError(ctx1, 'Errore nei dati di copertura');
            showChartError(ctx2, 'Errore nei dati di distribuzione');
        });
}

// Aggiorna legenda etichette
function updateLabelsLegend(data) {
    const legendContainer = document.getElementById('labelsChartLegend');
    if (!legendContainer) return;
    
    let html = '<h6 class="mb-2">Etichette per categoria:</h6><div class="chart-legend">';
    
    // Raggruppa per categoria
    const byCategory = {};
    data.labels.forEach((label, index) => {
        const category = data.categories[index];
        if (!byCategory[category]) {
            byCategory[category] = [];
        }
        byCategory[category].push({
            name: label,
            color: data.colors[index],
            value: data.values[index]
        });
    });
    
    Object.entries(byCategory).forEach(([category, labels]) => {
        html += `<div class="mb-2"><strong>${category}:</strong></div>`;
        labels.forEach(label => {
            html += `
                <div class="legend-item">
                    <div class="legend-color" style="background-color: ${label.color}"></div>
                    <div class="legend-text">${label.name}</div>
                    <div class="legend-value">${label.value}</div>
                </div>
            `;
        });
    });
    
    html += '</div>';
    legendContainer.innerHTML = html;
}

// Aggiorna statistiche annotatori
function updateAnnotatorsStats(data) {
    const statsContainer = document.getElementById('annotatorsStats');
    if (!statsContainer) return;
    
    const totalAnnotations = data.annotations.reduce((a, b) => a + b, 0);
    const totalCells = data.cells.reduce((a, b) => a + b, 0);
    const avgIntensity = totalCells > 0 ? (totalAnnotations / totalCells).toFixed(1) : 0;
    
    statsContainer.innerHTML = `
        <div class="card bg-light">
            <div class="card-body p-3">
                <h6 class="card-title">Statistiche Generali</h6>
                <small>
                    <strong>Totale Annotazioni:</strong> ${totalAnnotations}<br>
                    <strong>Totale Celle:</strong> ${totalCells}<br>
                    <strong>Intensità Media:</strong> ${avgIntensity} ann./cella<br>
                    <strong>Annotatori Attivi:</strong> ${data.labels.length}
                </small>
            </div>
        </div>
    `;
}

// Aggiorna statistiche categorie
function updateCategoriesStats(data) {
    const statsContainer = document.getElementById('categoriesStats');
    if (!statsContainer) return;
    
    const total = data.annotations.reduce((a, b) => a + b, 0);
    const maxCategory = data.categories[data.annotations.indexOf(Math.max(...data.annotations))];
    const maxValue = Math.max(...data.annotations);
    const percentage = ((maxValue / total) * 100).toFixed(1);
    
    statsContainer.innerHTML = `
        <div class="card bg-light">
            <div class="card-body p-3">
                <h6 class="card-title">Analisi Tematica</h6>
                <small>
                    <strong>Categoria Predominante:</strong><br>
                    ${maxCategory} (${maxValue} annotazioni, ${percentage}%)<br><br>
                    <strong>Totale Categorie:</strong> ${data.categories.length}<br>
                    <strong>Distribuzione:</strong> ${data.categories.length > 1 ? 'Diversificata' : 'Concentrata'}
                </small>
            </div>
        </div>
    `;
}

// Aggiorna statistiche copertura
function updateCoverageStats(data) {
    const statsContainer = document.getElementById('coverageStats');
    if (!statsContainer) return;
    
    const qualityLevel = data.coverage_percentage >= 80 ? 'Ottima' : 
                        data.coverage_percentage >= 60 ? 'Buona' : 
                        data.coverage_percentage >= 40 ? 'Discreta' : 'Bassa';
    const qualityClass = data.coverage_percentage >= 80 ? 'success' : 
                        data.coverage_percentage >= 60 ? 'info' : 
                        data.coverage_percentage >= 40 ? 'warning' : 'danger';
    
    statsContainer.innerHTML = `
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center p-2">
                    <h6 class="text-primary">${data.total_cells}</h6>
                    <small>Celle Totali</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center p-2">
                    <h6 class="text-success">${data.annotated_cells}</h6>
                    <small>Celle Annotate</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center p-2">
                    <h6 class="text-${qualityClass}">${data.coverage_percentage.toFixed(1)}%</h6>
                    <small>Copertura</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center p-2">
                    <h6 class="text-${qualityClass}">${qualityLevel}</h6>
                    <small>Qualità</small>
                </div>
            </div>
        </div>
    `;
}

// Mostra loader per grafico
function showChartLoader(ctx) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.fillStyle = '#6c757d';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Caricamento...', ctx.canvas.width / 2, ctx.canvas.height / 2);
}

// Ottieni filtri correnti per i grafici
function getCurrentChartFilters() {
    const categoryFilter = document.getElementById('chart-category-filter');
    const labelFilter = document.getElementById('chart-label-filter');
    const minUsage = document.getElementById('chart-min-usage');
    const maxUsage = document.getElementById('chart-max-usage');
    
    const filters = {};
    
    if (categoryFilter && categoryFilter.value) {
        filters.category = categoryFilter.value;
    }
    
    if (labelFilter && labelFilter.value.trim()) {
        filters.label_name = labelFilter.value.trim();
    }
    
    if (minUsage && minUsage.value) {
        filters.min_usage = minUsage.value;
    }
    
    if (maxUsage && maxUsage.value) {
        filters.max_usage = maxUsage.value;
    }
    
    return filters;
}

// Ottieni descrizione dei filtri applicati
function getFilterDescription() {
    const filters = getCurrentChartFilters();
    const descriptions = [];
    
    if (filters.category) {
        descriptions.push(`Categoria: ${filters.category}`);
    }
    
    if (filters.label_name) {
        descriptions.push(`Etichetta: "${filters.label_name}"`);
    }
    
    if (filters.min_usage) {
        descriptions.push(`Min: ${filters.min_usage}`);
    }
    
    if (filters.max_usage) {
        descriptions.push(`Max: ${filters.max_usage}`);
    }
    
    if (descriptions.length > 0) {
        return `(Filtri: ${descriptions.join(', ')})`;
    }
    
    return '';
}

// Aggiorna tutti i grafici con i filtri correnti
function updateAllCharts() {
    console.log('🔄 Aggiornamento tutti i grafici...');
    
    // Protezione filtri prima dell'aggiornamento
    protectChartFilters();
    
    const updateBtn = document.getElementById('update-charts-btn');
    if (updateBtn) {
        updateBtn.disabled = true;
        updateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Aggiornando...';
    }
    
    const activeTab = document.querySelector('.nav-link.active');
    const filters = getCurrentChartFilters();
    
    console.log('📊 Filtri applicati:', filters);
    
    // Aggiorna stato filtri
    updateFilterStatus(filters);
    
    try {
        if (activeTab) {
            const tabId = activeTab.id;
            console.log(`🎯 Tab attivo: ${tabId}`);
            
            if (tabId === 'labels-chart-tab') {
                loadLabelsChart();
            } else if (tabId === 'annotators-chart-tab') {
                loadAnnotatorsChart();
            } else if (tabId === 'categories-chart-tab') {
                loadCategoriesChart();
            } else if (tabId === 'coverage-chart-tab') {
                loadCoverageCharts();
            }
        } else {
            console.log('🎯 Nessun tab attivo, carico grafici etichette di default');
            loadLabelsChart();
        }
    } catch (error) {
        console.error('❌ Errore durante aggiornamento grafici:', error);
    } finally {
        // Ripristina il pulsante dopo un delay
        setTimeout(() => {
            if (updateBtn) {
                updateBtn.disabled = false;
                updateBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Aggiorna';
            }
        }, 1000);
    }
}

// Reset filtri dei grafici
function resetChartFilters() {
    console.log('🔄 Reset filtri grafici...');
    
    // Protezione filtri
    protectChartFilters();
    
    const categoryFilter = document.getElementById('chart-category-filter');
    const labelFilter = document.getElementById('chart-label-filter');
    const minUsage = document.getElementById('chart-min-usage');
    const maxUsage = document.getElementById('chart-max-usage');
    
    if (categoryFilter) categoryFilter.value = '';
    if (labelFilter) labelFilter.value = '';
    if (minUsage) minUsage.value = '';
    if (maxUsage) maxUsage.value = '';
    
    updateFilterStatus({});
    updateAllCharts();
    
    console.log('✅ Reset filtri completato');
}

// Aggiorna stato dei filtri
function updateFilterStatus(filters) {
    const statusElement = document.getElementById('chart-filter-status');
    if (!statusElement) return;
    
    const filterCount = Object.keys(filters).length;
    
    if (filterCount > 0) {
        statusElement.innerHTML = `<span class="badge bg-info">${filterCount} filtro${filterCount > 1 ? 'i' : ''} attivo${filterCount > 1 ? 'i' : ''}</span>`;
    } else {
        statusElement.innerHTML = '<span class="badge bg-secondary">Nessun filtro</span>';
    }
}

// Mostra loader per grafico
function showChartLoader(ctx) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.fillStyle = '#6c757d';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Caricamento...', ctx.canvas.width / 2, ctx.canvas.height / 2);
}

// Mostra errore per grafico
function showChartError(ctx, message) {
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.fillStyle = '#dc3545';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
}

// Carica grafico categorie (aggiornato con filtri)
function loadCategoriesChart() {
    if (categoriesChart) {
        categoriesChart.destroy();
    }
    
    const canvas = document.getElementById('categoriesDistributionChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    showChartLoader(ctx);
    
    // Ottieni filtri correnti
    const filters = getCurrentChartFilters();
    const queryString = new URLSearchParams(filters).toString();
    
    fetch(`/statistics/api/question_chart_data/{{ file.id }}/categories_distribution?${queryString}&question={{ question|urlencode }}`)
        .then(response => response.json())
        .then(data => {
            if (data.categories.length === 0) {
                showChartError(ctx, 'Nessuna categoria trovata con i filtri applicati');
                updateCategoriesStats({categories: [], annotations: [], labels_count: []});
                return;
            }
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
            ];
            
            categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.categories,
                    datasets: [{
                        label: 'Annotazioni',
                        data: data.annotations,
                        backgroundColor: colors.slice(0, data.categories.length),
                        borderColor: colors.slice(0, data.categories.length).map(color => color),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Distribuzione per categoria tematica ${getFilterDescription()}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = data.annotations.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    const labelCount = data.labels_count[context.dataIndex];
                                    return [
                                        `${context.label}: ${context.parsed} annotazioni (${percentage}%)`,
                                        `Etichette uniche: ${labelCount}`
                                    ];
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Aggiorna statistiche categorie
            updateCategoriesStats(data);
        })
        .catch(error => {
            console.error('Errore nel caricamento del grafico categorie:', error);
            showChartError(ctx, 'Errore nel caricamento dei dati delle categorie');
        });
}

// Carica grafici di copertura (aggiornato con filtri)
function loadCoverageCharts() {
    const canvas1 = document.getElementById('coverageOverviewChart');
    const canvas2 = document.getElementById('coverageDistributionChart');
    
    if (!canvas1 || !canvas2) return;
    
    const ctx1 = canvas1.getContext('2d');
    const ctx2 = canvas2.getContext('2d');
    
    showChartLoader(ctx1);
    showChartLoader(ctx2);
    
    // Ottieni filtri correnti
    const filters = getCurrentChartFilters();
    const queryString = new URLSearchParams(filters).toString();
    
    fetch(`/statistics/api/question_chart_data/{{ file.id }}/{{ question|urlencode }}/coverage_analysis?${queryString}`)
        .then(response => response.json())
        .then(data => {
            // Grafico overview copertura
            if (coverageOverviewChart) {
                coverageOverviewChart.destroy();
            }
            
            const filterSuffix = data.filtered ? ' (Filtrato)' : '';
            
            coverageOverviewChart = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: ['Celle Annotate', 'Celle Non Annotate'],
                    datasets: [{
                        data: [data.annotated_cells, data.unannotated_cells],
                        backgroundColor: ['#28a745', '#dc3545'],
                        borderColor: ['#28a745', '#dc3545'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Copertura: ${data.coverage_percentage.toFixed(1)}%${filterSuffix}`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / data.total_cells) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} celle (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Grafico distribuzione intensità
            if (coverageDistributionChart) {
                coverageDistributionChart.destroy();
            }
            
            if (data.distribution_labels.length === 0) {
                showChartError(ctx2, 'Nessun dato di distribuzione con i filtri applicati');
            } else {
                coverageDistributionChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: data.distribution_labels,
                        datasets: [{
                            label: 'Numero di celle',
                            data: data.distribution_values,
                            backgroundColor: 'rgba(255, 193, 7, 0.8)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Intensità di annotazione${filterSuffix}`,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Numero di celle'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Annotazioni per cella'
                                }
                            }
                        }
                    }
                });
            }
            
            // Aggiorna statistiche copertura
            updateCoverageStats(data);
        })
        .catch(error => {
            console.error('Errore nel caricamento dei grafici di copertura:', error);
            showChartError(ctx1, 'Errore nei dati di copertura');
            showChartError(ctx2, 'Errore nei dati di distribuzione');
        });
}

// Setup filtri (funzionalità esistenti)
function setupFilters() {
    const form = document.getElementById('label-filters-form');
    if (!form) return;
    
    const inputs = form.querySelectorAll('input[type="text"], input[type="number"]');
    
    // Aggiungi debounce per evitare troppe richieste
    let timeout;
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                // Auto-submit è disabilitato di default
            }, 1000);
        });
    });
    
    // Evidenzia automaticamente se c'è un termine di ricerca
    const searchInput = document.getElementById('label-name-filter');
    if (searchInput && searchInput.value) {
        toggleHighlight();
    }
    
    // Aggiungi contatori in tempo reale
    updateFilterCounters();
}

// Export CSV delle etichette filtrate
function exportLabelsCSV() {
    const table = document.getElementById('labels-table');
    if (!table) return;
    
    const rows = table.querySelectorAll('tbody tr:not([style*="display: none"])');
    
    if (rows.length === 0) {
        alert('Nessuna etichetta da esportare!');
        return;
    }
    
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Etichetta,Categoria,Utilizzi\n";
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const labelName = cells[0].querySelector('.label-badge').textContent.trim();
        const category = cells[1].textContent.trim();
        const usage = cells[2].querySelector('strong').textContent.trim();
        
        csvContent += `"${labelName}","${category}","${usage}"\n`;
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "etichette_quesito_{{ question|replace(' ', '_') }}_{{ file.filename|replace('.xlsx', '') }}.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Export report completo in vari formati
function exportCompleteReport(format) {
    // Codice per export report (mantenuto dall'implementazione precedente)
    // ... (resto del codice di export) ...
    console.log(`Export in formato ${format} richiesto`);
    alert(`Funzione export ${format} in sviluppo`);
}

// Toggle evidenziazione termini cercati
function toggleHighlight() {
    highlightEnabled = !highlightEnabled;
    const searchInput = document.getElementById('label-name-filter');
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const badges = document.querySelectorAll('.label-badge');
    
    badges.forEach(badge => {
        if (highlightEnabled && searchTerm) {
            const text = badge.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                badge.style.boxShadow = '0 0 10px #ffc107';
                badge.style.border = '2px solid #ffc107';
            }
        } else {
            badge.style.boxShadow = '';
            badge.style.border = '';
        }
    });
    
    // Cambia icona del pulsante
    const btn = event.target.closest('button');
    if (btn) {
        const icon = btn.querySelector('i');
        if (highlightEnabled) {
            icon.className = 'bi bi-highlighter-fill';
            btn.classList.add('active');
        } else {
            icon.className = 'bi bi-highlighter';
            btn.classList.remove('active');
        }
    }
}

// Aggiorna contatori dei filtri
function updateFilterCounters() {
    const table = document.getElementById('labels-table');
    if (!table) return;
    
    const totalRows = table.querySelectorAll('tbody tr').length;
    const visibleRows = table.querySelectorAll('tbody tr:not([style*="display: none"])').length;
    
    // Aggiorna il contatore se necessario
    const counter = document.querySelector('.text-muted small');
    if (counter && totalRows !== visibleRows) {
        counter.innerHTML = `<i class="bi bi-info-circle me-1"></i>Visualizzate ${visibleRows} di ${totalRows} etichette <span class="badge bg-secondary ms-1">Filtrate</span>`;
    }
}

// Funzione per reset rapido dei filtri
function resetFilters() {
    window.location.href = "{{ url_for('statistics.question_detail', file_id=file.id, question=question) }}";
}

// Shortcuts da tastiera
document.addEventListener('keydown', function(e) {
    // Ctrl+F per focus sulla ricerca
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.getElementById('label-name-filter');
        if (searchInput) {
            searchInput.focus();
        }
    }
    
    // Escape per reset filtri
    if (e.key === 'Escape') {
        const activeElement = document.activeElement;
        if (activeElement && (activeElement.id === 'label-name-filter' || activeElement.name)) {
            resetFilters();
        }
    }
});

// Tooltip per spiegare i filtri
document.addEventListener('DOMContentLoaded', function() {
    // Aggiungi tooltip se Bootstrap è disponibile
    if (typeof bootstrap !== 'undefined') {
        const tooltipElements = document.querySelectorAll('[title]');
        tooltipElements.forEach(el => {
            new bootstrap.Tooltip(el);
        });
    }
});
</script>

{% endblock %}
