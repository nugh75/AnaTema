{% extends "base.html" %}

{% block title %}Revisione Annotazioni AI - {{ excel_file.original_filename }}{% endblock %}

{% block extra_css %}
<style>
.annotation-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.annotation-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.annotation-header {
    background-color: #f8f9fa;
    padding: 12px 15px;
    border-bottom: 1px solid #dee2e6;
    border-radius: 8px 8px 0 0;
}

.annotation-body {
    padding: 15px;
}

.text-content {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    border-left: 4px solid #007bff;
    margin-bottom: 10px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.5;
}

.suggested-label {
    display: inline-block;
    padding: 6px 12px;
    background-color: #007bff;
    color: white;
    border-radius: 15px;
    font-size: 0.9em;
    margin-bottom: 10px;
}

.confidence-score {
    font-size: 0.85em;
    color: #6c757d;
}

.confidence-bar {
    height: 6px;
    background-color: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 4px;
}

.confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
    transition: width 0.3s ease;
}

.review-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 15px;
}

.stats-panel {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    display: block;
}

.batch-controls {
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.filter-controls {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.selected-annotation {
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.ai-model-info {
    font-size: 0.8em;
    color: #6c757d;
    margin-top: 5px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 4em;
    margin-bottom: 20px;
    opacity: 0.5;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-eye-fill me-2"></i>Revisione Annotazioni AI</h2>
                    <p class="text-muted mb-0">File: {{ excel_file.original_filename }}</p>
                </div>
                <div>
                    <button onclick="window.close()" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-x-lg"></i> Chiudi
                    </button>
                    <a href="{{ url_for('excel.view_question', file_id=excel_file.id, question_name='') }}" 
                       class="btn btn-primary" target="_blank">
                        <i class="bi bi-arrow-left"></i> Torna al File
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiche -->
    <div class="stats-panel">
        <div class="row">
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-number">{{ total_cells }}</span>
                    <div>Risposte Totali</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-number">{{ annotated_cells }}</span>
                    <div>Annotate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-number">{{ ai_annotations_count }}</span>
                    <div>Annotazioni AI</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-number">{{ pending_annotations|length }}</span>
                    <div>Da Rivedere</div>
                </div>
            </div>
        </div>
    </div>

    {% if pending_annotations %}
        <!-- Controlli Batch -->
        <div class="batch-controls">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-2">Azioni in Blocco</h6>
                    <div class="d-flex gap-2">
                        <button id="select-all" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-check-all"></i> Seleziona Tutti
                        </button>
                        <button id="select-none" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-x-square"></i> Deseleziona Tutti
                        </button>
                        <button id="batch-accept" class="btn btn-sm btn-success" disabled>
                            <i class="bi bi-check-circle"></i> Accetta Selezionati
                        </button>
                        <button id="batch-reject" class="btn btn-sm btn-danger" disabled>
                            <i class="bi bi-x-circle"></i> Rifiuta Selezionati
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="text-end">
                        <span id="selected-count" class="badge bg-info text-dark">0 selezionati</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtri -->
        <div class="filter-controls">
            <div class="row">
                <div class="col-md-4">
                    <label for="confidence-filter" class="form-label">Filtra per Confidence:</label>
                    <select id="confidence-filter" class="form-select form-select-sm">
                        <option value="">Tutti</option>
                        <option value="high">Alta (>80%)</option>
                        <option value="medium">Media (50-80%)</option>
                        <option value="low">Bassa (<50%)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="label-filter" class="form-label">Filtra per Etichetta:</label>
                    <select id="label-filter" class="form-select form-select-sm">
                        <option value="">Tutte</option>
                        {% for annotation in pending_annotations %}
                            {% set label_name = annotation.label %}
                            <option value="{{ label_name }}">{{ label_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="sort-by" class="form-label">Ordina per:</label>
                    <select id="sort-by" class="form-select form-select-sm">
                        <option value="confidence-desc">Confidence (Alta → Bassa)</option>
                        <option value="confidence-asc">Confidence (Bassa → Alta)</option>
                        <option value="created-desc">Data (Recente → Vecchia)</option>
                        <option value="created-asc">Data (Vecchia → Recente)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Lista Annotazioni -->
        <div id="annotations-container">
            {% for annotation in pending_annotations %}
            <div class="annotation-card" 
                 data-annotation-id="{{ annotation.id }}"
                 data-confidence="{{ annotation.confidence }}"
                 data-label="{{ annotation.label }}"
                 data-created="{{ annotation.created_at }}">
                
                <div class="annotation-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input class="form-check-input annotation-checkbox" type="checkbox" 
                                   value="{{ annotation.id }}" id="check-{{ annotation.id }}">
                            <label class="form-check-label" for="check-{{ annotation.id }}">
                                Annotazione #{{ annotation.id }}
                            </label>
                        </div>
                        <div class="ai-model-info">
                            <i class="bi bi-robot"></i> {{ annotation.provider }} - {{ annotation.model }}
                        </div>
                    </div>
                </div>
                
                <div class="annotation-body">
                    <!-- Testo originale -->
                    <div class="text-content">
                        {{ annotation.text[:300] }}{% if annotation.text|length > 300 %}...{% endif %}
                    </div>
                    
                    <!-- Etichetta suggerita -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <span class="suggested-label">{{ annotation.label }}</span>
                            <div class="confidence-score">
                                Confidence: {{ "%.1f"|format(annotation.confidence * 100) }}%
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: {{ annotation.confidence * 100 }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="text-muted text-end">
                            <small>{{ annotation.created_at }}</small>
                        </div>
                    </div>
                    
                    <!-- Azioni -->
                    <div class="review-actions">
                        <button class="btn btn-success btn-sm accept-btn" 
                                data-annotation-id="{{ annotation.id }}">
                            <i class="bi bi-check-circle"></i> Accetta
                        </button>
                        <button class="btn btn-danger btn-sm reject-btn" 
                                data-annotation-id="{{ annotation.id }}">
                            <i class="bi bi-x-circle"></i> Rifiuta
                        </button>
                        <button class="btn btn-outline-info btn-sm view-full-text" 
                                data-text="{{ annotation.text|e }}">
                            <i class="bi bi-eye"></i> Testo Completo
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Stato vuoto -->
        <div class="empty-state">
            <i class="bi bi-check-circle-fill text-success"></i>
            <h4>Nessuna Annotazione da Rivedere</h4>
            <p>Tutte le annotazioni AI sono state processate o non ci sono annotazioni AI per questo file.</p>
            <a href="{{ url_for('excel.view_question', file_id=excel_file.id, question_name='') }}" 
               class="btn btn-primary">
                <i class="bi bi-arrow-left"></i> Torna al File
            </a>
        </div>
    {% endif %}
</div>

<!-- Modal per testo completo -->
<div class="modal fade" id="fullTextModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Testo Completo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="full-text-content" class="text-content"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM caricato, inizializzazione...');
    try {
        initializeEventListeners();
        updateSelectedCount();
        console.log('✅ Inizializzazione completata');
    } catch (error) {
        console.error('❌ Errore durante inizializzazione:', error);
    }
});

function initializeEventListeners() {
    console.log('🔧 Inizializzazione event listeners...');
    
    // Verifica esistenza elementi
    console.log('📊 Elementi trovati:');
    console.log('- annotation-checkbox:', document.querySelectorAll('.annotation-checkbox').length);
    console.log('- accept-btn:', document.querySelectorAll('.accept-btn').length);
    console.log('- reject-btn:', document.querySelectorAll('.reject-btn').length);
    console.log('- select-all:', document.getElementById('select-all'));
    console.log('- batch-accept:', document.getElementById('batch-accept'));
    
    // Checkbox singole
    document.querySelectorAll('.annotation-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    // Controlli batch
    const selectAllBtn = document.getElementById('select-all');
    const selectNoneBtn = document.getElementById('select-none');
    const batchAcceptBtn = document.getElementById('batch-accept');
    const batchRejectBtn = document.getElementById('batch-reject');
    
    if (selectAllBtn) selectAllBtn.addEventListener('click', selectAll);
    if (selectNoneBtn) selectNoneBtn.addEventListener('click', selectNone);
    if (batchAcceptBtn) batchAcceptBtn.addEventListener('click', batchAccept);
    if (batchRejectBtn) batchRejectBtn.addEventListener('click', batchReject);
    
    // Azioni singole
    document.querySelectorAll('.accept-btn').forEach(btn => {
        console.log('Adding accept listener to button:', btn);
        btn.addEventListener('click', e => {
            console.log('Accept button clicked!', e.target.dataset.annotationId);
            reviewAnnotation(e.target.dataset.annotationId, 'accept');
        });
    });
    
    document.querySelectorAll('.reject-btn').forEach(btn => {
        console.log('Adding reject listener to button:', btn);
        btn.addEventListener('click', e => {
            console.log('Reject button clicked!', e.target.dataset.annotationId);
            reviewAnnotation(e.target.dataset.annotationId, 'reject');
        });
    });
    
    // Visualizza testo completo
    document.querySelectorAll('.view-full-text').forEach(btn => {
        btn.addEventListener('click', e => {
            document.getElementById('full-text-content').textContent = e.target.dataset.text;
            new bootstrap.Modal(document.getElementById('fullTextModal')).show();
        });
    });
    
    // Filtri
    const confidenceFilter = document.getElementById('confidence-filter');
    const labelFilter = document.getElementById('label-filter');
    const sortBy = document.getElementById('sort-by');
    
    if (confidenceFilter) confidenceFilter.addEventListener('change', applyFilters);
    if (labelFilter) labelFilter.addEventListener('change', applyFilters);
    if (sortBy) sortBy.addEventListener('change', applyFilters);
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('.annotation-checkbox:checked');
    const count = selected.length;
    
    document.getElementById('selected-count').textContent = `${count} selezionati`;
    document.getElementById('batch-accept').disabled = count === 0;
    document.getElementById('batch-reject').disabled = count === 0;
}

function selectAll() {
    document.querySelectorAll('.annotation-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

function selectNone() {
    document.querySelectorAll('.annotation-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

function reviewAnnotation(annotationId, action) {
    console.log(`🔥 REVIEW: annotation ${annotationId} with action ${action}`);
    
    // Rimuoviamo temporaneamente il CSRF per il debug
    fetch(`/ai/review/${annotationId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Rimuovi l'annotazione dalla vista
            const card = document.querySelector(`[data-annotation-id="${annotationId}"]`);
            card.style.transition = 'all 0.3s ease';
            card.style.opacity = '0.5';
            card.style.transform = 'translateX(' + (action === 'accept' ? '100px' : '-100px') + ')';
            
            setTimeout(() => {
                card.remove();
                updateSelectedCount();
                
                // Controlla se non ci sono più annotazioni
                if (document.querySelectorAll('.annotation-card').length === 0) {
                    location.reload();
                }
            }, 300);
            
            // Mostra notifica
            showNotification(`Annotazione ${action === 'accept' ? 'accettata' : 'rifiutata'}`, 'success');
        } else {
            showNotification('Errore: ' + (data.error || 'Errore sconosciuto'), 'error');
        }
    })
    .catch(error => {
        console.error('Review error:', error);
        showNotification('Errore di connessione: ' + error.message, 'error');
    });
}

function batchAccept() {
    batchReview('accept');
}

function batchReject() {
    batchReview('reject');
}

function batchReview(action) {
    const selected = Array.from(document.querySelectorAll('.annotation-checkbox:checked'))
                          .map(checkbox => parseInt(checkbox.value));
    
    if (selected.length === 0) return;
    
    if (!confirm(`Vuoi ${action === 'accept' ? 'accettare' : 'rifiutare'} ${selected.length} annotazioni?`)) {
        return;
    }
    
    fetch('/ai/review/batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            annotation_ids: selected,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Rimuovi le annotazioni processate
            selected.forEach(id => {
                const card = document.querySelector(`[data-annotation-id="${id}"]`);
                if (card) card.remove();
            });
            
            updateSelectedCount();
            
            // Ricarica se non ci sono più annotazioni
            if (document.querySelectorAll('.annotation-card').length === 0) {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showNotification('Errore: ' + (data.error || 'Errore sconosciuto'), 'error');
        }
    })
    .catch(error => {
        showNotification('Errore di connessione: ' + error.message, 'error');
    });
}

function applyFilters() {
    const confidenceFilter = document.getElementById('confidence-filter').value;
    const labelFilter = document.getElementById('label-filter').value;
    const sortBy = document.getElementById('sort-by').value;
    
    let cards = Array.from(document.querySelectorAll('.annotation-card'));
    
    // Filtra
    cards.forEach(card => {
        let show = true;
        
        // Filtro confidence
        if (confidenceFilter) {
            const confidence = parseFloat(card.dataset.confidence);
            if (confidenceFilter === 'high' && confidence <= 0.8) show = false;
            if (confidenceFilter === 'medium' && (confidence <= 0.5 || confidence > 0.8)) show = false;
            if (confidenceFilter === 'low' && confidence > 0.5) show = false;
        }
        
        // Filtro etichetta
        if (labelFilter && card.dataset.label !== labelFilter) {
            show = false;
        }
        
        card.style.display = show ? 'block' : 'none';
    });
    
    // Ordina
    const visibleCards = cards.filter(card => card.style.display !== 'none');
    visibleCards.sort((a, b) => {
        switch (sortBy) {
            case 'confidence-desc':
                return parseFloat(b.dataset.confidence) - parseFloat(a.dataset.confidence);
            case 'confidence-asc':
                return parseFloat(a.dataset.confidence) - parseFloat(b.dataset.confidence);
            case 'created-desc':
                return new Date(b.dataset.created) - new Date(a.dataset.created);
            case 'created-asc':
                return new Date(a.dataset.created) - new Date(b.dataset.created);
            default:
                return 0;
        }
    });
    
    const container = document.getElementById('annotations-container');
    visibleCards.forEach(card => container.appendChild(card));
}

function showNotification(message, type) {
    // Semplice sistema di notifiche
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function getCSRFToken() {
    const metaTag = document.querySelector('meta[name=csrf-token]');
    if (metaTag) {
        return metaTag.getAttribute('content');
    }
    
    const hiddenInput = document.querySelector('input[name="csrf_token"]');
    if (hiddenInput) {
        return hiddenInput.value;
    }
    
    return null;
}
</script>
{% endblock %}
